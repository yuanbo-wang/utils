(function(ie,re){typeof exports=="object"&&typeof module<"u"?re(exports):typeof define=="function"&&define.amd?define(["exports"],re):(ie=typeof globalThis<"u"?globalThis:ie||self,re(ie.index={}))})(this,function(ie){"use strict";var re=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Or(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var Z=function(){this.init=function(){var e={};this.on=function(t,i){e[t]||(e[t]=[]),e[t]=e[t].concat(i)},this.off=function(t,i){var r;return e[t]?(r=e[t].indexOf(i),e[t]=e[t].slice(),e[t].splice(r,1),r>-1):!1},this.trigger=function(t){var i,r,n,a;if(i=e[t],!!i)if(arguments.length===2)for(n=i.length,r=0;r<n;++r)i[r].call(this,arguments[1]);else{for(a=[],r=arguments.length,r=1;r<arguments.length;++r)a.push(arguments[r]);for(n=i.length,r=0;r<n;++r)i[r].apply(this,a)}},this.dispose=function(){e={}}}};Z.prototype.pipe=function(s){return this.on("data",function(e){s.push(e)}),this.on("done",function(e){s.flush(e)}),this.on("partialdone",function(e){s.partialFlush(e)}),this.on("endedtimeline",function(e){s.endTimeline(e)}),this.on("reset",function(e){s.reset(e)}),s},Z.prototype.push=function(s){this.trigger("data",s)},Z.prototype.flush=function(s){this.trigger("done",s)},Z.prototype.partialFlush=function(s){this.trigger("partialdone",s)},Z.prototype.endTimeline=function(s){this.trigger("endedtimeline",s)},Z.prototype.reset=function(s){this.trigger("reset",s)};var M=Z,ut=9e4,lt,ft,_e,dt,Yt,qt,Xt;lt=function(e){return e*ut},ft=function(e,t){return e*t},_e=function(e){return e/ut},dt=function(e,t){return e/t},Yt=function(e,t){return lt(dt(e,t))},qt=function(e,t){return ft(_e(e),t)},Xt=function(e,t,i){return _e(i?e:e-t)};var Y={ONE_SECOND_IN_TS:ut,secondsToVideoTs:lt,secondsToAudioTs:ft,videoTsToSeconds:_e,audioTsToSeconds:dt,audioTsToVideoTs:Yt,videoTsToAudioTs:qt,metadataTsToSeconds:Xt},Lr=M,Mr=Y.ONE_SECOND_IN_TS,Fe,Kt=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];Fe=function(e){var t,i=0;Fe.prototype.init.call(this),this.skipWarn_=function(r,n){this.trigger("log",{level:"warn",message:"adts skiping bytes "+r+" to "+n+" in frame "+i+" outside syncword"})},this.push=function(r){var n=0,a,o,u,f,l;if(e||(i=0),r.type==="audio"){t&&t.length?(u=t,t=new Uint8Array(u.byteLength+r.data.byteLength),t.set(u),t.set(r.data,u.byteLength)):t=r.data;for(var d;n+7<t.length;){if(t[n]!==255||(t[n+1]&246)!==240){typeof d!="number"&&(d=n),n++;continue}if(typeof d=="number"&&(this.skipWarn_(d,n),d=null),o=(~t[n+1]&1)*2,a=(t[n+3]&3)<<11|t[n+4]<<3|(t[n+5]&224)>>5,f=((t[n+6]&3)+1)*1024,l=f*Mr/Kt[(t[n+2]&60)>>>2],t.byteLength-n<a)break;this.trigger("data",{pts:r.pts+i*l,dts:r.dts+i*l,sampleCount:f,audioobjecttype:(t[n+2]>>>6&3)+1,channelcount:(t[n+2]&1)<<2|(t[n+3]&192)>>>6,samplerate:Kt[(t[n+2]&60)>>>2],samplingfrequencyindex:(t[n+2]&60)>>>2,samplesize:16,data:t.subarray(n+7+o,n+a)}),i++,n+=a}typeof d=="number"&&(this.skipWarn_(d,n),d=null),t=t.subarray(n)}},this.flush=function(){i=0,this.trigger("done")},this.reset=function(){t=void 0,this.trigger("reset")},this.endTimeline=function(){t=void 0,this.trigger("endedtimeline")}},Fe.prototype=new Lr;var Ae=Fe,jt;jt=function(e){var t=e.byteLength,i=0,r=0;this.length=function(){return 8*t},this.bitsAvailable=function(){return 8*t+r},this.loadWord=function(){var n=e.byteLength-t,a=new Uint8Array(4),o=Math.min(4,t);if(o===0)throw new Error("no bytes available");a.set(e.subarray(n,n+o)),i=new DataView(a.buffer).getUint32(0),r=o*8,t-=o},this.skipBits=function(n){var a;r>n?(i<<=n,r-=n):(n-=r,a=Math.floor(n/8),n-=a*8,t-=a,this.loadWord(),i<<=n,r-=n)},this.readBits=function(n){var a=Math.min(r,n),o=i>>>32-a;return r-=a,r>0?i<<=a:t>0&&this.loadWord(),a=n-a,a>0?o<<a|this.readBits(a):o},this.skipLeadingZeros=function(){var n;for(n=0;n<r;++n)if(i&2147483648>>>n)return i<<=n,r-=n,n;return this.loadWord(),n+this.skipLeadingZeros()},this.skipUnsignedExpGolomb=function(){this.skipBits(1+this.skipLeadingZeros())},this.skipExpGolomb=function(){this.skipBits(1+this.skipLeadingZeros())},this.readUnsignedExpGolomb=function(){var n=this.skipLeadingZeros();return this.readBits(n+1)-1},this.readExpGolomb=function(){var n=this.readUnsignedExpGolomb();return 1&n?1+n>>>1:-1*(n>>>1)},this.readBoolean=function(){return this.readBits(1)===1},this.readUnsignedByte=function(){return this.readBits(8)},this.loadWord()};var Rr=jt,Zt=M,Nr=Rr,De,le,Jt;le=function(){var e=0,t,i;le.prototype.init.call(this),this.push=function(r){var n;i?(n=new Uint8Array(i.byteLength+r.data.byteLength),n.set(i),n.set(r.data,i.byteLength),i=n):i=r.data;for(var a=i.byteLength;e<a-3;e++)if(i[e+2]===1){t=e+5;break}for(;t<a;)switch(i[t]){case 0:if(i[t-1]!==0){t+=2;break}else if(i[t-2]!==0){t++;break}e+3!==t-2&&this.trigger("data",i.subarray(e+3,t-2));do t++;while(i[t]!==1&&t<a);e=t-2,t+=3;break;case 1:if(i[t-1]!==0||i[t-2]!==0){t+=3;break}this.trigger("data",i.subarray(e+3,t-2)),e=t-2,t+=3;break;default:t+=3;break}i=i.subarray(e),t-=e,e=0},this.reset=function(){i=null,e=0,this.trigger("reset")},this.flush=function(){i&&i.byteLength>3&&this.trigger("data",i.subarray(e+3)),i=null,e=0,this.trigger("done")},this.endTimeline=function(){this.flush(),this.trigger("endedtimeline")}},le.prototype=new Zt,Jt={100:!0,110:!0,122:!0,244:!0,44:!0,83:!0,86:!0,118:!0,128:!0,138:!0,139:!0,134:!0},De=function(){var e=new le,t,i,r,n,a,o,u;De.prototype.init.call(this),t=this,this.push=function(f){f.type==="video"&&(i=f.trackId,r=f.pts,n=f.dts,e.push(f))},e.on("data",function(f){var l={trackId:i,pts:r,dts:n,data:f,nalUnitTypeCode:f[0]&31};switch(l.nalUnitTypeCode){case 5:l.nalUnitType="slice_layer_without_partitioning_rbsp_idr";break;case 6:l.nalUnitType="sei_rbsp",l.escapedRBSP=a(f.subarray(1));break;case 7:l.nalUnitType="seq_parameter_set_rbsp",l.escapedRBSP=a(f.subarray(1)),l.config=o(l.escapedRBSP);break;case 8:l.nalUnitType="pic_parameter_set_rbsp";break;case 9:l.nalUnitType="access_unit_delimiter_rbsp";break}t.trigger("data",l)}),e.on("done",function(){t.trigger("done")}),e.on("partialdone",function(){t.trigger("partialdone")}),e.on("reset",function(){t.trigger("reset")}),e.on("endedtimeline",function(){t.trigger("endedtimeline")}),this.flush=function(){e.flush()},this.partialFlush=function(){e.partialFlush()},this.reset=function(){e.reset()},this.endTimeline=function(){e.endTimeline()},u=function(l,d){var h=8,m=8,p,c;for(p=0;p<l;p++)m!==0&&(c=d.readExpGolomb(),m=(h+c+256)%256),h=m===0?h:m},a=function(l){for(var d=l.byteLength,h=[],m=1,p,c;m<d-2;)l[m]===0&&l[m+1]===0&&l[m+2]===3?(h.push(m+2),m+=2):m++;if(h.length===0)return l;p=d-h.length,c=new Uint8Array(p);var g=0;for(m=0;m<p;g++,m++)g===h[0]&&(g++,h.shift()),c[m]=l[g];return c},o=function(l){var d=0,h=0,m=0,p=0,c,g,w,F,H,we,D,v,P,L,O,A=[1,1],Er,te;if(c=new Nr(l),g=c.readUnsignedByte(),F=c.readUnsignedByte(),w=c.readUnsignedByte(),c.skipUnsignedExpGolomb(),Jt[g]&&(H=c.readUnsignedExpGolomb(),H===3&&c.skipBits(1),c.skipUnsignedExpGolomb(),c.skipUnsignedExpGolomb(),c.skipBits(1),c.readBoolean()))for(O=H!==3?8:12,te=0;te<O;te++)c.readBoolean()&&(te<6?u(16,c):u(64,c));if(c.skipUnsignedExpGolomb(),we=c.readUnsignedExpGolomb(),we===0)c.readUnsignedExpGolomb();else if(we===1)for(c.skipBits(1),c.skipExpGolomb(),c.skipExpGolomb(),D=c.readUnsignedExpGolomb(),te=0;te<D;te++)c.skipExpGolomb();if(c.skipUnsignedExpGolomb(),c.skipBits(1),v=c.readUnsignedExpGolomb(),P=c.readUnsignedExpGolomb(),L=c.readBits(1),L===0&&c.skipBits(1),c.skipBits(1),c.readBoolean()&&(d=c.readUnsignedExpGolomb(),h=c.readUnsignedExpGolomb(),m=c.readUnsignedExpGolomb(),p=c.readUnsignedExpGolomb()),c.readBoolean()&&c.readBoolean()){switch(Er=c.readUnsignedByte(),Er){case 1:A=[1,1];break;case 2:A=[12,11];break;case 3:A=[10,11];break;case 4:A=[16,11];break;case 5:A=[40,33];break;case 6:A=[24,11];break;case 7:A=[20,11];break;case 8:A=[32,11];break;case 9:A=[80,33];break;case 10:A=[18,11];break;case 11:A=[15,11];break;case 12:A=[64,33];break;case 13:A=[160,99];break;case 14:A=[4,3];break;case 15:A=[3,2];break;case 16:A=[2,1];break;case 255:{A=[c.readUnsignedByte()<<8|c.readUnsignedByte(),c.readUnsignedByte()<<8|c.readUnsignedByte()];break}}A&&A[0]/A[1]}return{profileIdc:g,levelIdc:w,profileCompatibility:F,width:(v+1)*16-d*2-h*2,height:(2-L)*(P+1)*16-m*2-p*2,sarRatio:A}}},De.prototype=new Zt;var ht={H264Stream:De,NalByteStream:le},Qt={Adts:Ae,h264:ht},ei=Math.pow(2,32),kr=function(e){var t=new DataView(e.buffer,e.byteOffset,e.byteLength),i;return t.getBigUint64?(i=t.getBigUint64(0),i<Number.MAX_SAFE_INTEGER?Number(i):i):t.getUint32(0)*ei+t.getUint32(4)},ne={getUint64:kr,MAX_UINT32:ei},ti=ne.MAX_UINT32,y,ii,ri,pt,ni,ai,si,oi,mt,ui,li,fi,di,hi,pi,mi,ci,gi,xi,yi,vi,ct,x,gt,Si,Ti,bi,wi,_i,Fi,Ai,Di,Ue,Ui,Pi,Ci;(function(){var s;if(x={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],mvex:[],mvhd:[],pasp:[],sdtp:[],smhd:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],styp:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[]},!(typeof Uint8Array>"u")){for(s in x)x.hasOwnProperty(s)&&(x[s]=[s.charCodeAt(0),s.charCodeAt(1),s.charCodeAt(2),s.charCodeAt(3)]);gt=new Uint8Array([105,115,111,109]),Ti=new Uint8Array([97,118,99,49]),Si=new Uint8Array([0,0,0,1]),bi=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),wi=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]),_i={video:bi,audio:wi},Di=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),Ai=new Uint8Array([0,0,0,0,0,0,0,0]),Ue=new Uint8Array([0,0,0,0,0,0,0,0]),Ui=Ue,Pi=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),Ci=Ue,Fi=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0])}})(),y=function(e){var t=[],i=0,r,n,a;for(r=1;r<arguments.length;r++)t.push(arguments[r]);for(r=t.length;r--;)i+=t[r].byteLength;for(n=new Uint8Array(i+8),a=new DataView(n.buffer,n.byteOffset,n.byteLength),a.setUint32(0,n.byteLength),n.set(e,4),r=0,i=8;r<t.length;r++)n.set(t[r],i),i+=t[r].byteLength;return n},ii=function(){return y(x.dinf,y(x.dref,Di))},ri=function(e){return y(x.esds,new Uint8Array([0,0,0,0,3,25,0,0,0,4,17,64,21,0,6,0,0,0,218,192,0,0,218,192,5,2,e.audioobjecttype<<3|e.samplingfrequencyindex>>>1,e.samplingfrequencyindex<<7|e.channelcount<<3,6,1,2]))},pt=function(){return y(x.ftyp,gt,Si,gt,Ti)},mi=function(e){return y(x.hdlr,_i[e])},ni=function(e){return y(x.mdat,e)},pi=function(e){var t=new Uint8Array([0,0,0,0,0,0,0,2,0,0,0,3,0,1,95,144,e.duration>>>24&255,e.duration>>>16&255,e.duration>>>8&255,e.duration&255,85,196,0,0]);return e.samplerate&&(t[12]=e.samplerate>>>24&255,t[13]=e.samplerate>>>16&255,t[14]=e.samplerate>>>8&255,t[15]=e.samplerate&255),y(x.mdhd,t)},hi=function(e){return y(x.mdia,pi(e),mi(e.type),si(e))},ai=function(e){return y(x.mfhd,new Uint8Array([0,0,0,0,(e&4278190080)>>24,(e&16711680)>>16,(e&65280)>>8,e&255]))},si=function(e){return y(x.minf,e.type==="video"?y(x.vmhd,Fi):y(x.smhd,Ai),ii(),gi(e))},oi=function(e,t){for(var i=[],r=t.length;r--;)i[r]=yi(t[r]);return y.apply(null,[x.moof,ai(e)].concat(i))},mt=function(e){for(var t=e.length,i=[];t--;)i[t]=fi(e[t]);return y.apply(null,[x.moov,li(4294967295)].concat(i).concat(ui(e)))},ui=function(e){for(var t=e.length,i=[];t--;)i[t]=vi(e[t]);return y.apply(null,[x.mvex].concat(i))},li=function(e){var t=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,2,0,1,95,144,(e&4278190080)>>24,(e&16711680)>>16,(e&65280)>>8,e&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return y(x.mvhd,t)},ci=function(e){var t=e.samples||[],i=new Uint8Array(4+t.length),r,n;for(n=0;n<t.length;n++)r=t[n].flags,i[n+4]=r.dependsOn<<4|r.isDependedOn<<2|r.hasRedundancy;return y(x.sdtp,i)},gi=function(e){return y(x.stbl,xi(e),y(x.stts,Ci),y(x.stsc,Ui),y(x.stsz,Pi),y(x.stco,Ue))},function(){var s,e;xi=function(i){return y(x.stsd,new Uint8Array([0,0,0,0,0,0,0,1]),i.type==="video"?s(i):e(i))},s=function(i){var r=i.sps||[],n=i.pps||[],a=[],o=[],u,f;for(u=0;u<r.length;u++)a.push((r[u].byteLength&65280)>>>8),a.push(r[u].byteLength&255),a=a.concat(Array.prototype.slice.call(r[u]));for(u=0;u<n.length;u++)o.push((n[u].byteLength&65280)>>>8),o.push(n[u].byteLength&255),o=o.concat(Array.prototype.slice.call(n[u]));if(f=[x.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,(i.width&65280)>>8,i.width&255,(i.height&65280)>>8,i.height&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,19,118,105,100,101,111,106,115,45,99,111,110,116,114,105,98,45,104,108,115,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),y(x.avcC,new Uint8Array([1,i.profileIdc,i.profileCompatibility,i.levelIdc,255].concat([r.length],a,[n.length],o))),y(x.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192]))],i.sarRatio){var l=i.sarRatio[0],d=i.sarRatio[1];f.push(y(x.pasp,new Uint8Array([(l&4278190080)>>24,(l&16711680)>>16,(l&65280)>>8,l&255,(d&4278190080)>>24,(d&16711680)>>16,(d&65280)>>8,d&255])))}return y.apply(null,f)},e=function(i){return y(x.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,(i.channelcount&65280)>>8,i.channelcount&255,(i.samplesize&65280)>>8,i.samplesize&255,0,0,0,0,(i.samplerate&65280)>>8,i.samplerate&255,0,0]),ri(i))}}(),di=function(e){var t=new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,(e.id&4278190080)>>24,(e.id&16711680)>>16,(e.id&65280)>>8,e.id&255,0,0,0,0,(e.duration&4278190080)>>24,(e.duration&16711680)>>16,(e.duration&65280)>>8,e.duration&255,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,(e.width&65280)>>8,e.width&255,0,0,(e.height&65280)>>8,e.height&255,0,0]);return y(x.tkhd,t)},yi=function(e){var t,i,r,n,a,o,u;return t=y(x.tfhd,new Uint8Array([0,0,0,58,(e.id&4278190080)>>24,(e.id&16711680)>>16,(e.id&65280)>>8,e.id&255,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0])),o=Math.floor(e.baseMediaDecodeTime/ti),u=Math.floor(e.baseMediaDecodeTime%ti),i=y(x.tfdt,new Uint8Array([1,0,0,0,o>>>24&255,o>>>16&255,o>>>8&255,o&255,u>>>24&255,u>>>16&255,u>>>8&255,u&255])),a=92,e.type==="audio"?(r=ct(e,a),y(x.traf,t,i,r)):(n=ci(e),r=ct(e,n.length+a),y(x.traf,t,i,r,n))},fi=function(e){return e.duration=e.duration||4294967295,y(x.trak,di(e),hi(e))},vi=function(e){var t=new Uint8Array([0,0,0,0,(e.id&4278190080)>>24,(e.id&16711680)>>16,(e.id&65280)>>8,e.id&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]);return e.type!=="video"&&(t[t.length-1]=0),y(x.trex,t)},function(){var s,e,t;t=function(r,n){var a=0,o=0,u=0,f=0;return r.length&&(r[0].duration!==void 0&&(a=1),r[0].size!==void 0&&(o=2),r[0].flags!==void 0&&(u=4),r[0].compositionTimeOffset!==void 0&&(f=8)),[0,0,a|o|u|f,1,(r.length&4278190080)>>>24,(r.length&16711680)>>>16,(r.length&65280)>>>8,r.length&255,(n&4278190080)>>>24,(n&16711680)>>>16,(n&65280)>>>8,n&255]},e=function(r,n){var a,o,u,f,l,d;for(f=r.samples||[],n+=20+16*f.length,u=t(f,n),o=new Uint8Array(u.length+f.length*16),o.set(u),a=u.length,d=0;d<f.length;d++)l=f[d],o[a++]=(l.duration&4278190080)>>>24,o[a++]=(l.duration&16711680)>>>16,o[a++]=(l.duration&65280)>>>8,o[a++]=l.duration&255,o[a++]=(l.size&4278190080)>>>24,o[a++]=(l.size&16711680)>>>16,o[a++]=(l.size&65280)>>>8,o[a++]=l.size&255,o[a++]=l.flags.isLeading<<2|l.flags.dependsOn,o[a++]=l.flags.isDependedOn<<6|l.flags.hasRedundancy<<4|l.flags.paddingValue<<1|l.flags.isNonSyncSample,o[a++]=l.flags.degradationPriority&61440,o[a++]=l.flags.degradationPriority&15,o[a++]=(l.compositionTimeOffset&4278190080)>>>24,o[a++]=(l.compositionTimeOffset&16711680)>>>16,o[a++]=(l.compositionTimeOffset&65280)>>>8,o[a++]=l.compositionTimeOffset&255;return y(x.trun,o)},s=function(r,n){var a,o,u,f,l,d;for(f=r.samples||[],n+=20+8*f.length,u=t(f,n),a=new Uint8Array(u.length+f.length*8),a.set(u),o=u.length,d=0;d<f.length;d++)l=f[d],a[o++]=(l.duration&4278190080)>>>24,a[o++]=(l.duration&16711680)>>>16,a[o++]=(l.duration&65280)>>>8,a[o++]=l.duration&255,a[o++]=(l.size&4278190080)>>>24,a[o++]=(l.size&16711680)>>>16,a[o++]=(l.size&65280)>>>8,a[o++]=l.size&255;return y(x.trun,a)},ct=function(r,n){return r.type==="audio"?s(r,n):e(r,n)}}();var Pe={ftyp:pt,mdat:ni,moof:oi,moov:mt,initSegment:function(e){var t=pt(),i=mt(e),r;return r=new Uint8Array(t.byteLength+i.byteLength),r.set(t),r.set(i,t.byteLength),r}},Br=function(e){return e>>>0},Vr=function(e){return("00"+e.toString(16)).slice(-2)},Ce={toUnsigned:Br,toHexString:Vr},$r=function(e){var t="";return t+=String.fromCharCode(e[0]),t+=String.fromCharCode(e[1]),t+=String.fromCharCode(e[2]),t+=String.fromCharCode(e[3]),t},xt=$r,zr=Ce.toUnsigned,Gr=xt,Wr=function s(e,t){var i=[],r,n,a,o,u;if(!t.length)return null;for(r=0;r<e.byteLength;)n=zr(e[r]<<24|e[r+1]<<16|e[r+2]<<8|e[r+3]),a=Gr(e.subarray(r+4,r+8)),o=n>1?r+n:e.byteLength,a===t[0]&&(t.length===1?i.push(e.subarray(r+8,o)):(u=s(e.subarray(r+8,o),t.slice(1)),u.length&&(i=i.concat(u)))),r=o;return i},yt=Wr,Hr=function(e){for(var t=0,i=String.fromCharCode(e[t]),r="";i!=="\0";)r+=i,t++,i=String.fromCharCode(e[t]);return r+=i,r},Yr={uint8ToCString:Hr},Ie=Yr.uint8ToCString,qr=ne.getUint64,Xr=function(e){var t=4,i=e[0],r,n,a,o,u,f,l,d;if(i===0){r=Ie(e.subarray(t)),t+=r.length,n=Ie(e.subarray(t)),t+=n.length;var h=new DataView(e.buffer);a=h.getUint32(t),t+=4,u=h.getUint32(t),t+=4,f=h.getUint32(t),t+=4,l=h.getUint32(t),t+=4}else if(i===1){var h=new DataView(e.buffer);a=h.getUint32(t),t+=4,o=qr(e.subarray(t)),t+=8,f=h.getUint32(t),t+=4,l=h.getUint32(t),t+=4,r=Ie(e.subarray(t)),t+=r.length,n=Ie(e.subarray(t)),t+=n.length}d=new Uint8Array(e.subarray(t,e.byteLength));var m={scheme_id_uri:r,value:n,timescale:a||1,presentation_time:o,presentation_time_delta:u,event_duration:f,id:l,message_data:d};return jr(i,m)?m:void 0},Kr=function(e,t,i,r){return e||e===0?e/t:r+i/t},jr=function(e,t){var i=t.scheme_id_uri!=="\0",r=e===0&&Ii(t.presentation_time_delta)&&i,n=e===1&&Ii(t.presentation_time)&&i;return!(e>1)&&r||n},Ii=function(e){return e!==void 0||e!==null},Zr={parseEmsgBox:Xr,scaleTime:Kr},Jr=function(e){var t=new DataView(e.buffer,e.byteOffset,e.byteLength),i={version:e[0],flags:new Uint8Array(e.subarray(1,4)),trackId:t.getUint32(4)},r=i.flags[2]&1,n=i.flags[2]&2,a=i.flags[2]&8,o=i.flags[2]&16,u=i.flags[2]&32,f=i.flags[0]&65536,l=i.flags[0]&131072,d;return d=8,r&&(d+=4,i.baseDataOffset=t.getUint32(12),d+=4),n&&(i.sampleDescriptionIndex=t.getUint32(d),d+=4),a&&(i.defaultSampleDuration=t.getUint32(d),d+=4),o&&(i.defaultSampleSize=t.getUint32(d),d+=4),u&&(i.defaultSampleFlags=t.getUint32(d)),f&&(i.durationIsEmpty=!0),!r&&l&&(i.baseDataOffsetIsMoof=!0),i},vt=Jr,Qr=function(e){return{isLeading:(e[0]&12)>>>2,dependsOn:e[0]&3,isDependedOn:(e[1]&192)>>>6,hasRedundancy:(e[1]&48)>>>4,paddingValue:(e[1]&14)>>>1,isNonSyncSample:e[1]&1,degradationPriority:e[2]<<8|e[3]}},en=Qr,Ei=en,tn=function(e){var t={version:e[0],flags:new Uint8Array(e.subarray(1,4)),samples:[]},i=new DataView(e.buffer,e.byteOffset,e.byteLength),r=t.flags[2]&1,n=t.flags[2]&4,a=t.flags[1]&1,o=t.flags[1]&2,u=t.flags[1]&4,f=t.flags[1]&8,l=i.getUint32(4),d=8,h;for(r&&(t.dataOffset=i.getInt32(d),d+=4),n&&l&&(h={flags:Ei(e.subarray(d,d+4))},d+=4,a&&(h.duration=i.getUint32(d),d+=4),o&&(h.size=i.getUint32(d),d+=4),f&&(t.version===1?h.compositionTimeOffset=i.getInt32(d):h.compositionTimeOffset=i.getUint32(d),d+=4),t.samples.push(h),l--);l--;)h={},a&&(h.duration=i.getUint32(d),d+=4),o&&(h.size=i.getUint32(d),d+=4),u&&(h.flags=Ei(e.subarray(d,d+4)),d+=4),f&&(t.version===1?h.compositionTimeOffset=i.getInt32(d):h.compositionTimeOffset=i.getUint32(d),d+=4),t.samples.push(h);return t},St=tn,rn=Ce.toUnsigned,nn=ne.getUint64,an=function(e){var t={version:e[0],flags:new Uint8Array(e.subarray(1,4))};return t.version===1?t.baseMediaDecodeTime=nn(e.subarray(4)):t.baseMediaDecodeTime=rn(e[4]<<24|e[5]<<16|e[6]<<8|e[7]),t},Tt=an,fe;typeof window<"u"?fe=window:typeof re<"u"?fe=re:typeof self<"u"?fe=self:fe={};var Oi=fe,sn=function(e,t,i){if(!e)return-1;for(var r=i;r<e.length;r++)if(e[r]===t)return r;return-1},on={typedArrayIndexOf:sn},Ee=on.typedArrayIndexOf,Oe={Utf8:3},Li=function(e,t,i){var r,n="";for(r=t;r<i;r++)n+="%"+("00"+e[r].toString(16)).slice(-2);return n},de=function(e,t,i){return decodeURIComponent(Li(e,t,i))},he=function(e,t,i){return unescape(Li(e,t,i))},pe=function(e){return e[0]<<21|e[1]<<14|e[2]<<7|e[3]},me={APIC:function(e){var t=1,i,r,n="-->";e.data[0]===Oe.Utf8&&(i=Ee(e.data,0,t),!(i<0)&&(e.mimeType=he(e.data,t,i),t=i+1,e.pictureType=e.data[t],t++,r=Ee(e.data,0,t),!(r<0)&&(e.description=de(e.data,t,r),t=r+1,e.mimeType===n?e.url=he(e.data,t,e.data.length):e.pictureData=e.data.subarray(t,e.data.length))))},"T*":function(e){e.data[0]===Oe.Utf8&&(e.value=de(e.data,1,e.data.length).replace(/\0*$/,""),e.values=e.value.split("\0"))},TXXX:function(e){var t;e.data[0]===Oe.Utf8&&(t=Ee(e.data,0,1),t!==-1&&(e.description=de(e.data,1,t),e.value=de(e.data,t+1,e.data.length).replace(/\0*$/,""),e.data=e.value))},"W*":function(e){e.url=he(e.data,0,e.data.length).replace(/\0.*$/,"")},WXXX:function(e){var t;e.data[0]===Oe.Utf8&&(t=Ee(e.data,0,1),t!==-1&&(e.description=de(e.data,1,t),e.url=he(e.data,t+1,e.data.length).replace(/\0.*$/,"")))},PRIV:function(e){var t;for(t=0;t<e.data.length;t++)if(e.data[t]===0){e.owner=he(e.data,0,t);break}e.privateData=e.data.subarray(t+1),e.data=e.privateData}},un=function(e){var t,i,r=10,n=0,a=[];if(!(e.length<10||e[0]!==73||e[1]!==68||e[2]!==51)){n=pe(e.subarray(6,10)),n+=10;var o=e[5]&64;o&&(r+=4,r+=pe(e.subarray(10,14)),n-=pe(e.subarray(16,20)));do{if(t=pe(e.subarray(r+4,r+8)),t<1)break;i=String.fromCharCode(e[r],e[r+1],e[r+2],e[r+3]);var u={id:i,data:e.subarray(r+10,r+t+10)};u.key=u.id,me[u.id]?me[u.id](u):u.id[0]==="T"?me["T*"](u):u.id[0]==="W"&&me["W*"](u),a.push(u),r+=10,r+=t}while(r<n);return a}},Mi={parseId3Frames:un,parseSyncSafeInteger:pe,frameParsers:me},Le=Ce.toUnsigned,ce=Ce.toHexString,C=yt,ae=xt,bt=Zr,ln=vt,fn=St,dn=Tt,hn=ne.getUint64,Ri,Ni,ki,Bi,Vi,wt,$i,_t=Oi,pn=Mi.parseId3Frames;Ri=function(e){var t={},i=C(e,["moov","trak"]);return i.reduce(function(r,n){var a,o,u,f,l;return a=C(n,["tkhd"])[0],!a||(o=a[0],u=o===0?12:20,f=Le(a[u]<<24|a[u+1]<<16|a[u+2]<<8|a[u+3]),l=C(n,["mdia","mdhd"])[0],!l)?null:(o=l[0],u=o===0?12:20,r[f]=Le(l[u]<<24|l[u+1]<<16|l[u+2]<<8|l[u+3]),r)},t)},Ni=function(e,t){var i;i=C(t,["moof","traf"]);var r=i.reduce(function(n,a){var o=C(a,["tfhd"])[0],u=Le(o[4]<<24|o[5]<<16|o[6]<<8|o[7]),f=e[u]||9e4,l=C(a,["tfdt"])[0],d=new DataView(l.buffer,l.byteOffset,l.byteLength),h;l[0]===1?h=hn(l.subarray(4,12)):h=d.getUint32(4);var m;return typeof h=="bigint"?m=h/_t.BigInt(f):typeof h=="number"&&!isNaN(h)&&(m=h/f),m<Number.MAX_SAFE_INTEGER&&(m=Number(m)),m<n&&(n=m),n},1/0);return typeof r=="bigint"||isFinite(r)?r:0},ki=function(e,t){var i=C(t,["moof","traf"]),r=0,n=0,a;if(i&&i.length){var o=C(i[0],["tfhd"])[0],u=C(i[0],["trun"])[0],f=C(i[0],["tfdt"])[0];if(o){var l=ln(o);a=l.trackId}if(f){var d=dn(f);r=d.baseMediaDecodeTime}if(u){var h=fn(u);h.samples&&h.samples.length&&(n=h.samples[0].compositionTimeOffset||0)}}var m=e[a]||9e4;typeof r=="bigint"&&(n=_t.BigInt(n),m=_t.BigInt(m));var p=(r+n)/m;return typeof p=="bigint"&&p<Number.MAX_SAFE_INTEGER&&(p=Number(p)),p},Bi=function(e){var t=C(e,["moov","trak"]),i=[];return t.forEach(function(r){var n=C(r,["mdia","hdlr"]),a=C(r,["tkhd"]);n.forEach(function(o,u){var f=ae(o.subarray(8,12)),l=a[u],d,h,m;f==="vide"&&(d=new DataView(l.buffer,l.byteOffset,l.byteLength),h=d.getUint8(0),m=h===0?d.getUint32(12):d.getUint32(20),i.push(m))})}),i},wt=function(e){var t=e[0],i=t===0?12:20;return Le(e[i]<<24|e[i+1]<<16|e[i+2]<<8|e[i+3])},Vi=function(e){var t=C(e,["moov","trak"]),i=[];return t.forEach(function(r){var n={},a=C(r,["tkhd"])[0],o,u;a&&(o=new DataView(a.buffer,a.byteOffset,a.byteLength),u=o.getUint8(0),n.id=u===0?o.getUint32(12):o.getUint32(20));var f=C(r,["mdia","hdlr"])[0];if(f){var l=ae(f.subarray(8,12));l==="vide"?n.type="video":l==="soun"?n.type="audio":n.type=l}var d=C(r,["mdia","minf","stbl","stsd"])[0];if(d){var h=d.subarray(8);n.codec=ae(h.subarray(4,8));var m=C(h,[n.codec])[0],p,c;m&&(/^[asm]vc[1-9]$/i.test(n.codec)?(p=m.subarray(78),c=ae(p.subarray(4,8)),c==="avcC"&&p.length>11?(n.codec+=".",n.codec+=ce(p[9]),n.codec+=ce(p[10]),n.codec+=ce(p[11])):n.codec="avc1.4d400d"):/^mp4[a,v]$/i.test(n.codec)?(p=m.subarray(28),c=ae(p.subarray(4,8)),c==="esds"&&p.length>20&&p[19]!==0?(n.codec+="."+ce(p[19]),n.codec+="."+ce(p[20]>>>2&63).replace(/^0/,"")):n.codec="mp4a.40.2"):n.codec=n.codec.toLowerCase())}var g=C(r,["mdia","mdhd"])[0];g&&(n.timescale=wt(g)),i.push(n)}),i},$i=function(e,t){t===void 0&&(t=0);var i=C(e,["emsg"]);return i.map(function(r){var n=bt.parseEmsgBox(new Uint8Array(r)),a=pn(n.message_data);return{cueTime:bt.scaleTime(n.presentation_time,n.timescale,n.presentation_time_delta,t),duration:bt.scaleTime(n.event_duration,n.timescale),frames:a}})};var mn={findBox:C,parseType:ae,timescale:Ri,startTime:Ni,compositionStartTime:ki,videoTrackIds:Bi,tracks:Vi,getTimescaleFromMediaHeader:wt,getEmsgID3:$i},cn=function(e){var t,i,r=[],n=[];for(n.byteLength=0,n.nalCount=0,n.duration=0,r.byteLength=0,t=0;t<e.length;t++)i=e[t],i.nalUnitType==="access_unit_delimiter_rbsp"?(r.length&&(r.duration=i.dts-r.dts,n.byteLength+=r.byteLength,n.nalCount+=r.length,n.duration+=r.duration,n.push(r)),r=[i],r.byteLength=i.data.byteLength,r.pts=i.pts,r.dts=i.dts):(i.nalUnitType==="slice_layer_without_partitioning_rbsp_idr"&&(r.keyFrame=!0),r.duration=i.dts-r.dts,r.byteLength+=i.data.byteLength,r.push(i));return n.length&&(!r.duration||r.duration<=0)&&(r.duration=n[n.length-1].duration),n.byteLength+=r.byteLength,n.nalCount+=r.length,n.duration+=r.duration,n.push(r),n},gn=function(e){var t,i,r=[],n=[];for(r.byteLength=0,r.nalCount=0,r.duration=0,r.pts=e[0].pts,r.dts=e[0].dts,n.byteLength=0,n.nalCount=0,n.duration=0,n.pts=e[0].pts,n.dts=e[0].dts,t=0;t<e.length;t++)i=e[t],i.keyFrame?(r.length&&(n.push(r),n.byteLength+=r.byteLength,n.nalCount+=r.nalCount,n.duration+=r.duration),r=[i],r.nalCount=i.length,r.byteLength=i.byteLength,r.pts=i.pts,r.dts=i.dts,r.duration=i.duration):(r.duration+=i.duration,r.nalCount+=i.length,r.byteLength+=i.byteLength,r.push(i));return n.length&&r.duration<=0&&(r.duration=n[n.length-1].duration),n.byteLength+=r.byteLength,n.nalCount+=r.nalCount,n.duration+=r.duration,n.push(r),n},xn=function(e){var t;return!e[0][0].keyFrame&&e.length>1&&(t=e.shift(),e.byteLength-=t.byteLength,e.nalCount-=t.nalCount,e[0][0].dts=t.dts,e[0][0].pts=t.pts,e[0][0].duration+=t.duration),e},yn=function(){return{size:0,flags:{isLeading:0,dependsOn:1,isDependedOn:0,hasRedundancy:0,degradationPriority:0,isNonSyncSample:1}}},zi=function(e,t){var i=yn();return i.dataOffset=t,i.compositionTimeOffset=e.pts-e.dts,i.duration=e.duration,i.size=4*e.length,i.size+=e.byteLength,e.keyFrame&&(i.flags.dependsOn=2,i.flags.isNonSyncSample=0),i},vn=function(e,t){var i,r,n,a,o,u=t||0,f=[];for(i=0;i<e.length;i++)for(a=e[i],r=0;r<a.length;r++)o=a[r],n=zi(o,u),u+=n.size,f.push(n);return f},Sn=function(e){var t,i,r,n,a,o,u=0,f=e.byteLength,l=e.nalCount,d=f+4*l,h=new Uint8Array(d),m=new DataView(h.buffer);for(t=0;t<e.length;t++)for(n=e[t],i=0;i<n.length;i++)for(a=n[i],r=0;r<a.length;r++)o=a[r],m.setUint32(u,o.data.byteLength),u+=4,h.set(o.data,u),u+=o.data.byteLength;return h},Tn=function(e,t){var i,r=t||0,n=[];return i=zi(e,r),n.push(i),n},bn=function(e){var t,i,r=0,n=e.byteLength,a=e.length,o=n+4*a,u=new Uint8Array(o),f=new DataView(u.buffer);for(t=0;t<e.length;t++)i=e[t],f.setUint32(r,i.data.byteLength),r+=4,u.set(i.data,r),r+=i.data.byteLength;return u},Gi={groupNalsIntoFrames:cn,groupFramesIntoGops:gn,extendFirstKeyFrame:xn,generateSampleTable:vn,concatenateNalData:Sn,generateSampleTableForFrame:Tn,concatenateNalDataForFrame:bn},q=[33,16,5,32,164,27],Ft=[33,65,108,84,1,2,4,8,168,2,4,8,17,191,252],T=function(e){for(var t=[];e--;)t.push(0);return t},wn=function(e){return Object.keys(e).reduce(function(t,i){return t[i]=new Uint8Array(e[i].reduce(function(r,n){return r.concat(n)},[])),t},{})},At,_n=function(){if(!At){var s={96e3:[q,[227,64],T(154),[56]],88200:[q,[231],T(170),[56]],64e3:[q,[248,192],T(240),[56]],48e3:[q,[255,192],T(268),[55,148,128],T(54),[112]],44100:[q,[255,192],T(268),[55,163,128],T(84),[112]],32e3:[q,[255,192],T(268),[55,234],T(226),[112]],24e3:[q,[255,192],T(268),[55,255,128],T(268),[111,112],T(126),[224]],16e3:[q,[255,192],T(268),[55,255,128],T(268),[111,255],T(269),[223,108],T(195),[1,192]],12e3:[Ft,T(268),[3,127,248],T(268),[6,255,240],T(268),[13,255,224],T(268),[27,253,128],T(259),[56]],11025:[Ft,T(268),[3,127,248],T(268),[6,255,240],T(268),[13,255,224],T(268),[27,255,192],T(268),[55,175,128],T(108),[112]],8e3:[Ft,T(268),[3,121,16],T(47),[7]]};At=wn(s)}return At},Fn=_n,Me=Y,An=function(e){var t,i,r=0;for(t=0;t<e.length;t++)i=e[t],r+=i.data.byteLength;return r},Dn=function(e,t,i,r){var n,a=0,o=0,u=0,f=0,l,d,h;if(t.length&&(n=Me.audioTsToVideoTs(e.baseMediaDecodeTime,e.samplerate),a=Math.ceil(Me.ONE_SECOND_IN_TS/(e.samplerate/1024)),i&&r&&(o=n-Math.max(i,r),u=Math.floor(o/a),f=u*a),!(u<1||f>Me.ONE_SECOND_IN_TS/2))){for(l=Fn()[e.samplerate],l||(l=t[0].data),d=0;d<u;d++)h=t[0],t.splice(0,0,{data:l,dts:h.dts-a,pts:h.pts-a});return e.baseMediaDecodeTime-=Math.floor(Me.videoTsToAudioTs(f,e.samplerate)),f}},Un=function(e,t,i){return t.minSegmentDts>=i?e:(t.minSegmentDts=1/0,e.filter(function(r){return r.dts>=i?(t.minSegmentDts=Math.min(t.minSegmentDts,r.dts),t.minSegmentPts=t.minSegmentDts,!0):!1}))},Pn=function(e){var t,i,r=[];for(t=0;t<e.length;t++)i=e[t],r.push({size:i.data.byteLength,duration:1024});return r},Cn=function(e){var t,i,r=0,n=new Uint8Array(An(e));for(t=0;t<e.length;t++)i=e[t],n.set(i.data,r),r+=i.data.byteLength;return n},Wi={prefixWithSilence:Dn,trimAdtsFramesByEarliestDts:Un,generateSampleTable:Pn,concatenateFrameData:Cn},In=Y.ONE_SECOND_IN_TS,En=function(e,t){typeof t.pts=="number"&&(e.timelineStartInfo.pts===void 0&&(e.timelineStartInfo.pts=t.pts),e.minSegmentPts===void 0?e.minSegmentPts=t.pts:e.minSegmentPts=Math.min(e.minSegmentPts,t.pts),e.maxSegmentPts===void 0?e.maxSegmentPts=t.pts:e.maxSegmentPts=Math.max(e.maxSegmentPts,t.pts)),typeof t.dts=="number"&&(e.timelineStartInfo.dts===void 0&&(e.timelineStartInfo.dts=t.dts),e.minSegmentDts===void 0?e.minSegmentDts=t.dts:e.minSegmentDts=Math.min(e.minSegmentDts,t.dts),e.maxSegmentDts===void 0?e.maxSegmentDts=t.dts:e.maxSegmentDts=Math.max(e.maxSegmentDts,t.dts))},On=function(e){delete e.minSegmentDts,delete e.maxSegmentDts,delete e.minSegmentPts,delete e.maxSegmentPts},Ln=function(e,t){var i,r,n=e.minSegmentDts;return t||(n-=e.timelineStartInfo.dts),i=e.timelineStartInfo.baseMediaDecodeTime,i+=n,i=Math.max(0,i),e.type==="audio"&&(r=e.samplerate/In,i*=r,i=Math.floor(i)),i},Re={clearDtsInfo:On,calculateTrackBaseMediaDecodeTime:Ln,collectDtsInfo:En},Hi=4,Mn=128,Rn=function(e){for(var t=0,i={payloadType:-1,payloadSize:0},r=0,n=0;t<e.byteLength&&e[t]!==Mn;){for(;e[t]===255;)r+=255,t++;for(r+=e[t++];e[t]===255;)n+=255,t++;if(n+=e[t++],!i.payload&&r===Hi){var a=String.fromCharCode(e[t+3],e[t+4],e[t+5],e[t+6]);if(a==="GA94"){i.payloadType=r,i.payloadSize=n,i.payload=e.subarray(t,t+n);break}else i.payload=void 0}t+=n,r=0,n=0}return i},Nn=function(e){return e.payload[0]!==181||(e.payload[1]<<8|e.payload[2])!==49||String.fromCharCode(e.payload[3],e.payload[4],e.payload[5],e.payload[6])!=="GA94"||e.payload[7]!==3?null:e.payload.subarray(8,e.payload.length-1)},kn=function(e,t){var i=[],r,n,a,o;if(!(t[0]&64))return i;for(n=t[0]&31,r=0;r<n;r++)a=r*3,o={type:t[a+2]&3,pts:e},t[a+2]&4&&(o.ccData=t[a+3]<<8|t[a+4],i.push(o));return i},Bn=function(e){for(var t=e.byteLength,i=[],r=1,n,a;r<t-2;)e[r]===0&&e[r+1]===0&&e[r+2]===3?(i.push(r+2),r+=2):r++;if(i.length===0)return e;n=t-i.length,a=new Uint8Array(n);var o=0;for(r=0;r<n;o++,r++)o===i[0]&&(o++,i.shift()),a[r]=e[o];return a},Yi={parseSei:Rn,parseUserData:Nn,parseCaptionPackets:kn,discardEmulationPreventionBytes:Bn,USER_DATA_REGISTERED_ITU_T_T35:Hi},Dt=M,Ne=Yi,R=function s(e){e=e||{},s.prototype.init.call(this),this.parse708captions_=typeof e.parse708captions=="boolean"?e.parse708captions:!0,this.captionPackets_=[],this.ccStreams_=[new U(0,0),new U(0,1),new U(1,0),new U(1,1)],this.parse708captions_&&(this.cc708Stream_=new _({captionServices:e.captionServices})),this.reset(),this.ccStreams_.forEach(function(t){t.on("data",this.trigger.bind(this,"data")),t.on("partialdone",this.trigger.bind(this,"partialdone")),t.on("done",this.trigger.bind(this,"done"))},this),this.parse708captions_&&(this.cc708Stream_.on("data",this.trigger.bind(this,"data")),this.cc708Stream_.on("partialdone",this.trigger.bind(this,"partialdone")),this.cc708Stream_.on("done",this.trigger.bind(this,"done")))};R.prototype=new Dt,R.prototype.push=function(s){var e,t,i;if(s.nalUnitType==="sei_rbsp"&&(e=Ne.parseSei(s.escapedRBSP),!!e.payload&&e.payloadType===Ne.USER_DATA_REGISTERED_ITU_T_T35&&(t=Ne.parseUserData(e),!!t))){if(s.dts<this.latestDts_){this.ignoreNextEqualDts_=!0;return}else if(s.dts===this.latestDts_&&this.ignoreNextEqualDts_){this.numSameDts_--,this.numSameDts_||(this.ignoreNextEqualDts_=!1);return}i=Ne.parseCaptionPackets(s.pts,t),this.captionPackets_=this.captionPackets_.concat(i),this.latestDts_!==s.dts&&(this.numSameDts_=0),this.numSameDts_++,this.latestDts_=s.dts}},R.prototype.flushCCStreams=function(s){this.ccStreams_.forEach(function(e){return s==="flush"?e.flush():e.partialFlush()},this)},R.prototype.flushStream=function(s){if(!this.captionPackets_.length){this.flushCCStreams(s);return}this.captionPackets_.forEach(function(e,t){e.presortIndex=t}),this.captionPackets_.sort(function(e,t){return e.pts===t.pts?e.presortIndex-t.presortIndex:e.pts-t.pts}),this.captionPackets_.forEach(function(e){e.type<2?this.dispatchCea608Packet(e):this.dispatchCea708Packet(e)},this),this.captionPackets_.length=0,this.flushCCStreams(s)},R.prototype.flush=function(){return this.flushStream("flush")},R.prototype.partialFlush=function(){return this.flushStream("partialFlush")},R.prototype.reset=function(){this.latestDts_=null,this.ignoreNextEqualDts_=!1,this.numSameDts_=0,this.activeCea608Channel_=[null,null],this.ccStreams_.forEach(function(s){s.reset()})},R.prototype.dispatchCea608Packet=function(s){this.setsTextOrXDSActive(s)?this.activeCea608Channel_[s.type]=null:this.setsChannel1Active(s)?this.activeCea608Channel_[s.type]=0:this.setsChannel2Active(s)&&(this.activeCea608Channel_[s.type]=1),this.activeCea608Channel_[s.type]!==null&&this.ccStreams_[(s.type<<1)+this.activeCea608Channel_[s.type]].push(s)},R.prototype.setsChannel1Active=function(s){return(s.ccData&30720)===4096},R.prototype.setsChannel2Active=function(s){return(s.ccData&30720)===6144},R.prototype.setsTextOrXDSActive=function(s){return(s.ccData&28928)===256||(s.ccData&30974)===4138||(s.ccData&30974)===6186},R.prototype.dispatchCea708Packet=function(s){this.parse708captions_&&this.cc708Stream_.push(s)};var Vn={127:9834,4128:32,4129:160,4133:8230,4138:352,4140:338,4144:9608,4145:8216,4146:8217,4147:8220,4148:8221,4149:8226,4153:8482,4154:353,4156:339,4157:8480,4159:376,4214:8539,4215:8540,4216:8541,4217:8542,4218:9168,4219:9124,4220:9123,4221:9135,4222:9126,4223:9121,4256:12600},$n=function(e){var t=Vn[e]||e;return e&4096&&e===t?"":String.fromCharCode(t)},ke=function(e){return 32<=e&&e<=127||160<=e&&e<=255},z=function(e){this.windowNum=e,this.reset()};z.prototype.reset=function(){this.clearText(),this.pendingNewLine=!1,this.winAttr={},this.penAttr={},this.penLoc={},this.penColor={},this.visible=0,this.rowLock=0,this.columnLock=0,this.priority=0,this.relativePositioning=0,this.anchorVertical=0,this.anchorHorizontal=0,this.anchorPoint=0,this.rowCount=1,this.virtualRowCount=this.rowCount+1,this.columnCount=41,this.windowStyle=0,this.penStyle=0},z.prototype.getText=function(){return this.rows.join(`
`)},z.prototype.clearText=function(){this.rows=[""],this.rowIdx=0},z.prototype.newLine=function(s){for(this.rows.length>=this.virtualRowCount&&typeof this.beforeRowOverflow=="function"&&this.beforeRowOverflow(s),this.rows.length>0&&(this.rows.push(""),this.rowIdx++);this.rows.length>this.virtualRowCount;)this.rows.shift(),this.rowIdx--},z.prototype.isEmpty=function(){return this.rows.length===0?!0:this.rows.length===1?this.rows[0]==="":!1},z.prototype.addText=function(s){this.rows[this.rowIdx]+=s},z.prototype.backspace=function(){if(!this.isEmpty()){var s=this.rows[this.rowIdx];this.rows[this.rowIdx]=s.substr(0,s.length-1)}};var Be=function(e,t,i){this.serviceNum=e,this.text="",this.currentWindow=new z(-1),this.windows=[],this.stream=i,typeof t=="string"&&this.createTextDecoder(t)};Be.prototype.init=function(s,e){this.startPts=s;for(var t=0;t<8;t++)this.windows[t]=new z(t),typeof e=="function"&&(this.windows[t].beforeRowOverflow=e)},Be.prototype.setCurrentWindow=function(s){this.currentWindow=this.windows[s]},Be.prototype.createTextDecoder=function(s){if(typeof TextDecoder>"u")this.stream.trigger("log",{level:"warn",message:"The `encoding` option is unsupported without TextDecoder support"});else try{this.textDecoder_=new TextDecoder(s)}catch(e){this.stream.trigger("log",{level:"warn",message:"TextDecoder could not be created with "+s+" encoding. "+e})}};var _=function s(e){e=e||{},s.prototype.init.call(this);var t=this,i=e.captionServices||{},r={},n;Object.keys(i).forEach(function(a){n=i[a],/^SERVICE/.test(a)&&(r[a]=n.encoding)}),this.serviceEncodings=r,this.current708Packet=null,this.services={},this.push=function(a){a.type===3?(t.new708Packet(),t.add708Bytes(a)):(t.current708Packet===null&&t.new708Packet(),t.add708Bytes(a))}};_.prototype=new Dt,_.prototype.new708Packet=function(){this.current708Packet!==null&&this.push708Packet(),this.current708Packet={data:[],ptsVals:[]}},_.prototype.add708Bytes=function(s){var e=s.ccData,t=e>>>8,i=e&255;this.current708Packet.ptsVals.push(s.pts),this.current708Packet.data.push(t),this.current708Packet.data.push(i)},_.prototype.push708Packet=function(){var s=this.current708Packet,e=s.data,t=null,i=null,r=0,n=e[r++];for(s.seq=n>>6,s.sizeCode=n&63;r<e.length;r++)n=e[r++],t=n>>5,i=n&31,t===7&&i>0&&(n=e[r++],t=n),this.pushServiceBlock(t,r,i),i>0&&(r+=i-1)},_.prototype.pushServiceBlock=function(s,e,t){var i,r=e,n=this.current708Packet.data,a=this.services[s];for(a||(a=this.initService(s,r));r<e+t&&r<n.length;r++)i=n[r],ke(i)?r=this.handleText(r,a):i===24?r=this.multiByteCharacter(r,a):i===16?r=this.extendedCommands(r,a):128<=i&&i<=135?r=this.setCurrentWindow(r,a):152<=i&&i<=159?r=this.defineWindow(r,a):i===136?r=this.clearWindows(r,a):i===140?r=this.deleteWindows(r,a):i===137?r=this.displayWindows(r,a):i===138?r=this.hideWindows(r,a):i===139?r=this.toggleWindows(r,a):i===151?r=this.setWindowAttributes(r,a):i===144?r=this.setPenAttributes(r,a):i===145?r=this.setPenColor(r,a):i===146?r=this.setPenLocation(r,a):i===143?a=this.reset(r,a):i===8?a.currentWindow.backspace():i===12?a.currentWindow.clearText():i===13?a.currentWindow.pendingNewLine=!0:i===14?a.currentWindow.clearText():i===141&&r++},_.prototype.extendedCommands=function(s,e){var t=this.current708Packet.data,i=t[++s];return ke(i)&&(s=this.handleText(s,e,{isExtended:!0})),s},_.prototype.getPts=function(s){return this.current708Packet.ptsVals[Math.floor(s/2)]},_.prototype.initService=function(s,e){var i="SERVICE"+s,t=this,i,r;return i in this.serviceEncodings&&(r=this.serviceEncodings[i]),this.services[s]=new Be(s,r,t),this.services[s].init(this.getPts(e),function(n){t.flushDisplayed(n,t.services[s])}),this.services[s]},_.prototype.handleText=function(s,e,t){var i=t&&t.isExtended,r=t&&t.isMultiByte,n=this.current708Packet.data,a=i?4096:0,o=n[s],u=n[s+1],f=e.currentWindow,l,d;return e.textDecoder_&&!i?(r?(d=[o,u],s++):d=[o],l=e.textDecoder_.decode(new Uint8Array(d))):l=$n(a|o),f.pendingNewLine&&!f.isEmpty()&&f.newLine(this.getPts(s)),f.pendingNewLine=!1,f.addText(l),s},_.prototype.multiByteCharacter=function(s,e){var t=this.current708Packet.data,i=t[s+1],r=t[s+2];return ke(i)&&ke(r)&&(s=this.handleText(++s,e,{isMultiByte:!0})),s},_.prototype.setCurrentWindow=function(s,e){var t=this.current708Packet.data,i=t[s],r=i&7;return e.setCurrentWindow(r),s},_.prototype.defineWindow=function(s,e){var t=this.current708Packet.data,i=t[s],r=i&7;e.setCurrentWindow(r);var n=e.currentWindow;return i=t[++s],n.visible=(i&32)>>5,n.rowLock=(i&16)>>4,n.columnLock=(i&8)>>3,n.priority=i&7,i=t[++s],n.relativePositioning=(i&128)>>7,n.anchorVertical=i&127,i=t[++s],n.anchorHorizontal=i,i=t[++s],n.anchorPoint=(i&240)>>4,n.rowCount=i&15,i=t[++s],n.columnCount=i&63,i=t[++s],n.windowStyle=(i&56)>>3,n.penStyle=i&7,n.virtualRowCount=n.rowCount+1,s},_.prototype.setWindowAttributes=function(s,e){var t=this.current708Packet.data,i=t[s],r=e.currentWindow.winAttr;return i=t[++s],r.fillOpacity=(i&192)>>6,r.fillRed=(i&48)>>4,r.fillGreen=(i&12)>>2,r.fillBlue=i&3,i=t[++s],r.borderType=(i&192)>>6,r.borderRed=(i&48)>>4,r.borderGreen=(i&12)>>2,r.borderBlue=i&3,i=t[++s],r.borderType+=(i&128)>>5,r.wordWrap=(i&64)>>6,r.printDirection=(i&48)>>4,r.scrollDirection=(i&12)>>2,r.justify=i&3,i=t[++s],r.effectSpeed=(i&240)>>4,r.effectDirection=(i&12)>>2,r.displayEffect=i&3,s},_.prototype.flushDisplayed=function(s,e){for(var t=[],i=0;i<8;i++)e.windows[i].visible&&!e.windows[i].isEmpty()&&t.push(e.windows[i].getText());e.endPts=s,e.text=t.join(`

`),this.pushCaption(e),e.startPts=s},_.prototype.pushCaption=function(s){s.text!==""&&(this.trigger("data",{startPts:s.startPts,endPts:s.endPts,text:s.text,stream:"cc708_"+s.serviceNum}),s.text="",s.startPts=s.endPts)},_.prototype.displayWindows=function(s,e){var t=this.current708Packet.data,i=t[++s],r=this.getPts(s);this.flushDisplayed(r,e);for(var n=0;n<8;n++)i&1<<n&&(e.windows[n].visible=1);return s},_.prototype.hideWindows=function(s,e){var t=this.current708Packet.data,i=t[++s],r=this.getPts(s);this.flushDisplayed(r,e);for(var n=0;n<8;n++)i&1<<n&&(e.windows[n].visible=0);return s},_.prototype.toggleWindows=function(s,e){var t=this.current708Packet.data,i=t[++s],r=this.getPts(s);this.flushDisplayed(r,e);for(var n=0;n<8;n++)i&1<<n&&(e.windows[n].visible^=1);return s},_.prototype.clearWindows=function(s,e){var t=this.current708Packet.data,i=t[++s],r=this.getPts(s);this.flushDisplayed(r,e);for(var n=0;n<8;n++)i&1<<n&&e.windows[n].clearText();return s},_.prototype.deleteWindows=function(s,e){var t=this.current708Packet.data,i=t[++s],r=this.getPts(s);this.flushDisplayed(r,e);for(var n=0;n<8;n++)i&1<<n&&e.windows[n].reset();return s},_.prototype.setPenAttributes=function(s,e){var t=this.current708Packet.data,i=t[s],r=e.currentWindow.penAttr;return i=t[++s],r.textTag=(i&240)>>4,r.offset=(i&12)>>2,r.penSize=i&3,i=t[++s],r.italics=(i&128)>>7,r.underline=(i&64)>>6,r.edgeType=(i&56)>>3,r.fontStyle=i&7,s},_.prototype.setPenColor=function(s,e){var t=this.current708Packet.data,i=t[s],r=e.currentWindow.penColor;return i=t[++s],r.fgOpacity=(i&192)>>6,r.fgRed=(i&48)>>4,r.fgGreen=(i&12)>>2,r.fgBlue=i&3,i=t[++s],r.bgOpacity=(i&192)>>6,r.bgRed=(i&48)>>4,r.bgGreen=(i&12)>>2,r.bgBlue=i&3,i=t[++s],r.edgeRed=(i&48)>>4,r.edgeGreen=(i&12)>>2,r.edgeBlue=i&3,s},_.prototype.setPenLocation=function(s,e){var t=this.current708Packet.data,i=t[s],r=e.currentWindow.penLoc;return e.currentWindow.pendingNewLine=!0,i=t[++s],r.row=i&15,i=t[++s],r.column=i&63,s},_.prototype.reset=function(s,e){var t=this.getPts(s);return this.flushDisplayed(t,e),this.initService(e.serviceNum,s)};var zn={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,304:174,305:176,306:189,307:191,308:8482,309:162,310:163,311:9834,312:224,313:160,314:232,315:226,316:234,317:238,318:244,319:251,544:193,545:201,546:211,547:218,548:220,549:252,550:8216,551:161,552:42,553:39,554:8212,555:169,556:8480,557:8226,558:8220,559:8221,560:192,561:194,562:199,563:200,564:202,565:203,566:235,567:206,568:207,569:239,570:212,571:217,572:249,573:219,574:171,575:187,800:195,801:227,802:205,803:204,804:236,805:210,806:242,807:213,808:245,809:123,810:125,811:92,812:94,813:95,814:124,815:126,816:196,817:228,818:214,819:246,820:223,821:165,822:164,823:9474,824:197,825:229,826:216,827:248,828:9484,829:9488,830:9492,831:9496},Ve=function(e){return e===null?"":(e=zn[e]||e,String.fromCharCode(e))},$e=14,Gn=[4352,4384,4608,4640,5376,5408,5632,5664,5888,5920,4096,4864,4896,5120,5152],J=function(){for(var e=[],t=$e+1;t--;)e.push("");return e},U=function s(e,t){s.prototype.init.call(this),this.field_=e||0,this.dataChannel_=t||0,this.name_="CC"+((this.field_<<1|this.dataChannel_)+1),this.setConstants(),this.reset(),this.push=function(i){var r,n,a,o,u;if(r=i.ccData&32639,r===this.lastControlCode_){this.lastControlCode_=null;return}if((r&61440)===4096?this.lastControlCode_=r:r!==this.PADDING_&&(this.lastControlCode_=null),a=r>>>8,o=r&255,r!==this.PADDING_)if(r===this.RESUME_CAPTION_LOADING_)this.mode_="popOn";else if(r===this.END_OF_CAPTION_)this.mode_="popOn",this.clearFormatting(i.pts),this.flushDisplayed(i.pts),n=this.displayed_,this.displayed_=this.nonDisplayed_,this.nonDisplayed_=n,this.startPts_=i.pts;else if(r===this.ROLL_UP_2_ROWS_)this.rollUpRows_=2,this.setRollUp(i.pts);else if(r===this.ROLL_UP_3_ROWS_)this.rollUpRows_=3,this.setRollUp(i.pts);else if(r===this.ROLL_UP_4_ROWS_)this.rollUpRows_=4,this.setRollUp(i.pts);else if(r===this.CARRIAGE_RETURN_)this.clearFormatting(i.pts),this.flushDisplayed(i.pts),this.shiftRowsUp_(),this.startPts_=i.pts;else if(r===this.BACKSPACE_)this.mode_==="popOn"?this.nonDisplayed_[this.row_]=this.nonDisplayed_[this.row_].slice(0,-1):this.displayed_[this.row_]=this.displayed_[this.row_].slice(0,-1);else if(r===this.ERASE_DISPLAYED_MEMORY_)this.flushDisplayed(i.pts),this.displayed_=J();else if(r===this.ERASE_NON_DISPLAYED_MEMORY_)this.nonDisplayed_=J();else if(r===this.RESUME_DIRECT_CAPTIONING_)this.mode_!=="paintOn"&&(this.flushDisplayed(i.pts),this.displayed_=J()),this.mode_="paintOn",this.startPts_=i.pts;else if(this.isSpecialCharacter(a,o))a=(a&3)<<8,u=Ve(a|o),this[this.mode_](i.pts,u),this.column_++;else if(this.isExtCharacter(a,o))this.mode_==="popOn"?this.nonDisplayed_[this.row_]=this.nonDisplayed_[this.row_].slice(0,-1):this.displayed_[this.row_]=this.displayed_[this.row_].slice(0,-1),a=(a&3)<<8,u=Ve(a|o),this[this.mode_](i.pts,u),this.column_++;else if(this.isMidRowCode(a,o))this.clearFormatting(i.pts),this[this.mode_](i.pts," "),this.column_++,(o&14)===14&&this.addFormatting(i.pts,["i"]),(o&1)===1&&this.addFormatting(i.pts,["u"]);else if(this.isOffsetControlCode(a,o))this.column_+=o&3;else if(this.isPAC(a,o)){var f=Gn.indexOf(r&7968);this.mode_==="rollUp"&&(f-this.rollUpRows_+1<0&&(f=this.rollUpRows_-1),this.setRollUp(i.pts,f)),f!==this.row_&&(this.clearFormatting(i.pts),this.row_=f),o&1&&this.formatting_.indexOf("u")===-1&&this.addFormatting(i.pts,["u"]),(r&16)===16&&(this.column_=((r&14)>>1)*4),this.isColorPAC(o)&&(o&14)===14&&this.addFormatting(i.pts,["i"])}else this.isNormalChar(a)&&(o===0&&(o=null),u=Ve(a),u+=Ve(o),this[this.mode_](i.pts,u),this.column_+=u.length)}};U.prototype=new Dt,U.prototype.flushDisplayed=function(s){var e=this.displayed_.map(function(t,i){try{return t.trim()}catch{return this.trigger("log",{level:"warn",message:"Skipping a malformed 608 caption at index "+i+"."}),""}},this).join(`
`).replace(/^\n+|\n+$/g,"");e.length&&this.trigger("data",{startPts:this.startPts_,endPts:s,text:e,stream:this.name_})},U.prototype.reset=function(){this.mode_="popOn",this.topRow_=0,this.startPts_=0,this.displayed_=J(),this.nonDisplayed_=J(),this.lastControlCode_=null,this.column_=0,this.row_=$e,this.rollUpRows_=2,this.formatting_=[]},U.prototype.setConstants=function(){this.dataChannel_===0?(this.BASE_=16,this.EXT_=17,this.CONTROL_=(20|this.field_)<<8,this.OFFSET_=23):this.dataChannel_===1&&(this.BASE_=24,this.EXT_=25,this.CONTROL_=(28|this.field_)<<8,this.OFFSET_=31),this.PADDING_=0,this.RESUME_CAPTION_LOADING_=this.CONTROL_|32,this.END_OF_CAPTION_=this.CONTROL_|47,this.ROLL_UP_2_ROWS_=this.CONTROL_|37,this.ROLL_UP_3_ROWS_=this.CONTROL_|38,this.ROLL_UP_4_ROWS_=this.CONTROL_|39,this.CARRIAGE_RETURN_=this.CONTROL_|45,this.RESUME_DIRECT_CAPTIONING_=this.CONTROL_|41,this.BACKSPACE_=this.CONTROL_|33,this.ERASE_DISPLAYED_MEMORY_=this.CONTROL_|44,this.ERASE_NON_DISPLAYED_MEMORY_=this.CONTROL_|46},U.prototype.isSpecialCharacter=function(s,e){return s===this.EXT_&&e>=48&&e<=63},U.prototype.isExtCharacter=function(s,e){return(s===this.EXT_+1||s===this.EXT_+2)&&e>=32&&e<=63},U.prototype.isMidRowCode=function(s,e){return s===this.EXT_&&e>=32&&e<=47},U.prototype.isOffsetControlCode=function(s,e){return s===this.OFFSET_&&e>=33&&e<=35},U.prototype.isPAC=function(s,e){return s>=this.BASE_&&s<this.BASE_+8&&e>=64&&e<=127},U.prototype.isColorPAC=function(s){return s>=64&&s<=79||s>=96&&s<=127},U.prototype.isNormalChar=function(s){return s>=32&&s<=127},U.prototype.setRollUp=function(s,e){if(this.mode_!=="rollUp"&&(this.row_=$e,this.mode_="rollUp",this.flushDisplayed(s),this.nonDisplayed_=J(),this.displayed_=J()),e!==void 0&&e!==this.row_)for(var t=0;t<this.rollUpRows_;t++)this.displayed_[e-t]=this.displayed_[this.row_-t],this.displayed_[this.row_-t]="";e===void 0&&(e=this.row_),this.topRow_=e-this.rollUpRows_+1},U.prototype.addFormatting=function(s,e){this.formatting_=this.formatting_.concat(e);var t=e.reduce(function(i,r){return i+"<"+r+">"},"");this[this.mode_](s,t)},U.prototype.clearFormatting=function(s){if(this.formatting_.length){var e=this.formatting_.reverse().reduce(function(t,i){return t+"</"+i+">"},"");this.formatting_=[],this[this.mode_](s,e)}},U.prototype.popOn=function(s,e){var t=this.nonDisplayed_[this.row_];t+=e,this.nonDisplayed_[this.row_]=t},U.prototype.rollUp=function(s,e){var t=this.displayed_[this.row_];t+=e,this.displayed_[this.row_]=t},U.prototype.shiftRowsUp_=function(){var s;for(s=0;s<this.topRow_;s++)this.displayed_[s]="";for(s=this.row_+1;s<$e+1;s++)this.displayed_[s]="";for(s=this.topRow_;s<this.row_;s++)this.displayed_[s]=this.displayed_[s+1];this.displayed_[this.row_]=""},U.prototype.paintOn=function(s,e){var t=this.displayed_[this.row_];t+=e,this.displayed_[this.row_]=t};var qi={CaptionStream:R,Cea608Stream:U,Cea708Stream:_},ze={H264_STREAM_TYPE:27,ADTS_STREAM_TYPE:15,METADATA_STREAM_TYPE:21},Wn=M,Hn=8589934592,Yn=4294967296,Xi="shared",Ut=function(e,t){var i=1;for(e>t&&(i=-1);Math.abs(t-e)>Yn;)e+=i*Hn;return e},Ki=function s(e){var t,i;s.prototype.init.call(this),this.type_=e||Xi,this.push=function(r){this.type_!==Xi&&r.type!==this.type_||(i===void 0&&(i=r.dts),r.dts=Ut(r.dts,i),r.pts=Ut(r.pts,i),t=r.dts,this.trigger("data",r))},this.flush=function(){i=t,this.trigger("done")},this.endTimeline=function(){this.flush(),this.trigger("endedtimeline")},this.discontinuity=function(){i=void 0,t=void 0},this.reset=function(){this.discontinuity(),this.trigger("reset")}};Ki.prototype=new Wn;var ji={TimestampRolloverStream:Ki,handleRollover:Ut},qn=M,Xn=ze,X=Mi,Ge;Ge=function(e){var t={descriptor:e&&e.descriptor},i=0,r=[],n=0,a;if(Ge.prototype.init.call(this),this.dispatchType=Xn.METADATA_STREAM_TYPE.toString(16),t.descriptor)for(a=0;a<t.descriptor.length;a++)this.dispatchType+=("00"+t.descriptor[a].toString(16)).slice(-2);this.push=function(o){var u,f,l,d,h,m;if(o.type==="timed-metadata"){if(o.dataAlignmentIndicator&&(n=0,r.length=0),r.length===0&&(o.data.length<10||o.data[0]!==73||o.data[1]!==68||o.data[2]!==51)){this.trigger("log",{level:"warn",message:"Skipping unrecognized metadata packet"});return}if(r.push(o),n+=o.data.byteLength,r.length===1&&(i=X.parseSyncSafeInteger(o.data.subarray(6,10)),i+=10),!(n<i)){for(u={data:new Uint8Array(i),frames:[],pts:r[0].pts,dts:r[0].dts},h=0;h<i;)u.data.set(r[0].data.subarray(0,i-h),h),h+=r[0].data.byteLength,n-=r[0].data.byteLength,r.shift();f=10,u.data[5]&64&&(f+=4,f+=X.parseSyncSafeInteger(u.data.subarray(10,14)),i-=X.parseSyncSafeInteger(u.data.subarray(16,20)));do{if(l=X.parseSyncSafeInteger(u.data.subarray(f+4,f+8)),l<1){this.trigger("log",{level:"warn",message:"Malformed ID3 frame encountered. Skipping remaining metadata parsing."});break}if(m=String.fromCharCode(u.data[f],u.data[f+1],u.data[f+2],u.data[f+3]),d={id:m,data:u.data.subarray(f+10,f+l+10)},d.key=d.id,X.frameParsers[d.id]?X.frameParsers[d.id](d):d.id[0]==="T"?X.frameParsers["T*"](d):d.id[0]==="W"&&X.frameParsers["W*"](d),d.owner==="com.apple.streaming.transportStreamTimestamp"){var p=d.data,c=(p[3]&1)<<30|p[4]<<22|p[5]<<14|p[6]<<6|p[7]>>>2;c*=4,c+=p[7]&3,d.timeStamp=c,u.pts===void 0&&u.dts===void 0&&(u.pts=d.timeStamp,u.dts=d.timeStamp),this.trigger("timestamp",d)}u.frames.push(d),f+=10,f+=l}while(f<i);this.trigger("data",u)}}}},Ge.prototype=new qn;var Kn=Ge,Pt=M,Ct=qi,B=ze,jn=ji.TimestampRolloverStream,We,ge,He,se=188,It=71;We=function(){var e=new Uint8Array(se),t=0;We.prototype.init.call(this),this.push=function(i){var r=0,n=se,a;for(t?(a=new Uint8Array(i.byteLength+t),a.set(e.subarray(0,t)),a.set(i,t),t=0):a=i;n<a.byteLength;){if(a[r]===It&&a[n]===It){this.trigger("data",a.subarray(r,n)),r+=se,n+=se;continue}r++,n++}r<a.byteLength&&(e.set(a.subarray(r),0),t=a.byteLength-r)},this.flush=function(){t===se&&e[0]===It&&(this.trigger("data",e),t=0),this.trigger("done")},this.endTimeline=function(){this.flush(),this.trigger("endedtimeline")},this.reset=function(){t=0,this.trigger("reset")}},We.prototype=new Pt,ge=function(){var e,t,i,r;ge.prototype.init.call(this),r=this,this.packetsWaitingForPmt=[],this.programMapTable=void 0,e=function(a,o){var u=0;o.payloadUnitStartIndicator&&(u+=a[u]+1),o.type==="pat"?t(a.subarray(u),o):i(a.subarray(u),o)},t=function(a,o){o.section_number=a[7],o.last_section_number=a[8],r.pmtPid=(a[10]&31)<<8|a[11],o.pmtPid=r.pmtPid},i=function(a,o){var u,f,l,d;if(a[5]&1){for(r.programMapTable={video:null,audio:null,"timed-metadata":{}},u=(a[1]&15)<<8|a[2],f=3+u-4,l=(a[10]&15)<<8|a[11],d=12+l;d<f;){var h=a[d],m=(a[d+1]&31)<<8|a[d+2];h===B.H264_STREAM_TYPE&&r.programMapTable.video===null?r.programMapTable.video=m:h===B.ADTS_STREAM_TYPE&&r.programMapTable.audio===null?r.programMapTable.audio=m:h===B.METADATA_STREAM_TYPE&&(r.programMapTable["timed-metadata"][m]=h),d+=((a[d+3]&15)<<8|a[d+4])+5}o.programMapTable=r.programMapTable}},this.push=function(n){var a={},o=4;if(a.payloadUnitStartIndicator=!!(n[1]&64),a.pid=n[1]&31,a.pid<<=8,a.pid|=n[2],(n[3]&48)>>>4>1&&(o+=n[o]+1),a.pid===0)a.type="pat",e(n.subarray(o),a),this.trigger("data",a);else if(a.pid===this.pmtPid)for(a.type="pmt",e(n.subarray(o),a),this.trigger("data",a);this.packetsWaitingForPmt.length;)this.processPes_.apply(this,this.packetsWaitingForPmt.shift());else this.programMapTable===void 0?this.packetsWaitingForPmt.push([n,o,a]):this.processPes_(n,o,a)},this.processPes_=function(n,a,o){o.pid===this.programMapTable.video?o.streamType=B.H264_STREAM_TYPE:o.pid===this.programMapTable.audio?o.streamType=B.ADTS_STREAM_TYPE:o.streamType=this.programMapTable["timed-metadata"][o.pid],o.type="pes",o.data=n.subarray(a),this.trigger("data",o)}},ge.prototype=new Pt,ge.STREAM_TYPES={h264:27,adts:15},He=function(){var e=this,t=!1,i={data:[],size:0},r={data:[],size:0},n={data:[],size:0},a,o=function(l,d){var h,m=l[0]<<16|l[1]<<8|l[2];d.data=new Uint8Array,m===1&&(d.packetLength=6+(l[4]<<8|l[5]),d.dataAlignmentIndicator=(l[6]&4)!==0,h=l[7],h&192&&(d.pts=(l[9]&14)<<27|(l[10]&255)<<20|(l[11]&254)<<12|(l[12]&255)<<5|(l[13]&254)>>>3,d.pts*=4,d.pts+=(l[13]&6)>>>1,d.dts=d.pts,h&64&&(d.dts=(l[14]&14)<<27|(l[15]&255)<<20|(l[16]&254)<<12|(l[17]&255)<<5|(l[18]&254)>>>3,d.dts*=4,d.dts+=(l[18]&6)>>>1)),d.data=l.subarray(9+l[8]))},u=function(l,d,h){var m=new Uint8Array(l.size),p={type:d},c=0,g=0,w=!1,F;if(!(!l.data.length||l.size<9)){for(p.trackId=l.data[0].pid,c=0;c<l.data.length;c++)F=l.data[c],m.set(F.data,g),g+=F.data.byteLength;o(m,p),w=d==="video"||p.packetLength<=l.size,(h||w)&&(l.size=0,l.data.length=0),w&&e.trigger("data",p)}};He.prototype.init.call(this),this.push=function(f){({pat:function(){},pes:function(){var d,h;switch(f.streamType){case B.H264_STREAM_TYPE:d=i,h="video";break;case B.ADTS_STREAM_TYPE:d=r,h="audio";break;case B.METADATA_STREAM_TYPE:d=n,h="timed-metadata";break;default:return}f.payloadUnitStartIndicator&&u(d,h,!0),d.data.push(f),d.size+=f.data.byteLength},pmt:function(){var d={type:"metadata",tracks:[]};a=f.programMapTable,a.video!==null&&d.tracks.push({timelineStartInfo:{baseMediaDecodeTime:0},id:+a.video,codec:"avc",type:"video"}),a.audio!==null&&d.tracks.push({timelineStartInfo:{baseMediaDecodeTime:0},id:+a.audio,codec:"adts",type:"audio"}),t=!0,e.trigger("data",d)}})[f.type]()},this.reset=function(){i.size=0,i.data.length=0,r.size=0,r.data.length=0,this.trigger("reset")},this.flushStreams_=function(){u(i,"video"),u(r,"audio"),u(n,"timed-metadata")},this.flush=function(){if(!t&&a){var f={type:"metadata",tracks:[]};a.video!==null&&f.tracks.push({timelineStartInfo:{baseMediaDecodeTime:0},id:+a.video,codec:"avc",type:"video"}),a.audio!==null&&f.tracks.push({timelineStartInfo:{baseMediaDecodeTime:0},id:+a.audio,codec:"adts",type:"audio"}),e.trigger("data",f)}t=!1,this.flushStreams_(),this.trigger("done")}},He.prototype=new Pt;var Zi={PAT_PID:0,MP2T_PACKET_LENGTH:se,TransportPacketStream:We,TransportParseStream:ge,ElementaryStream:He,TimestampRolloverStream:jn,CaptionStream:Ct.CaptionStream,Cea608Stream:Ct.Cea608Stream,Cea708Stream:Ct.Cea708Stream,MetadataStream:Kn};for(var Et in B)B.hasOwnProperty(Et)&&(Zi[Et]=B[Et]);var Ye=Zi,Zn=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],Ji=function(e,t){var i=e[t+6]<<21|e[t+7]<<14|e[t+8]<<7|e[t+9],r=e[t+5],n=(r&16)>>4;return i=i>=0?i:0,n?i+20:i+10},Jn=function s(e,t){return e.length-t<10||e[t]!==73||e[t+1]!==68||e[t+2]!==51?t:(t+=Ji(e,t),s(e,t))},Qn=function(e){var t=Jn(e,0);return e.length>=t+2&&(e[t]&255)===255&&(e[t+1]&240)===240&&(e[t+1]&22)===16},Qi=function(e){return e[0]<<21|e[1]<<14|e[2]<<7|e[3]},ea=function(e,t,i){var r,n="";for(r=t;r<i;r++)n+="%"+("00"+e[r].toString(16)).slice(-2);return n},ta=function(e,t,i){return unescape(ea(e,t,i))},ia=function(e,t){var i=(e[t+5]&224)>>5,r=e[t+4]<<3,n=e[t+3]&6144;return n|r|i},ra=function(e,t){return e[t]===73&&e[t+1]===68&&e[t+2]===51?"timed-metadata":e[t]&!0&&(e[t+1]&240)===240?"audio":null},na=function(e){for(var t=0;t+5<e.length;){if(e[t]!==255||(e[t+1]&246)!==240){t++;continue}return Zn[(e[t+2]&60)>>>2]}return null},aa=function(e){var t,i,r,n;t=10,e[5]&64&&(t+=4,t+=Qi(e.subarray(10,14)));do{if(i=Qi(e.subarray(t+4,t+8)),i<1)return null;if(n=String.fromCharCode(e[t],e[t+1],e[t+2],e[t+3]),n==="PRIV"){r=e.subarray(t+10,t+i+10);for(var a=0;a<r.byteLength;a++)if(r[a]===0){var o=ta(r,0,a);if(o==="com.apple.streaming.transportStreamTimestamp"){var u=r.subarray(a+1),f=(u[3]&1)<<30|u[4]<<22|u[5]<<14|u[6]<<6|u[7]>>>2;return f*=4,f+=u[7]&3,f}break}}t+=10,t+=i}while(t<e.byteLength);return null},qe={isLikelyAacData:Qn,parseId3TagSize:Ji,parseAdtsSize:ia,parseType:ra,parseSampleRate:na,parseAacTimestamp:aa},sa=M,er=qe,Xe;Xe=function(){var e=new Uint8Array,t=0;Xe.prototype.init.call(this),this.setTimestamp=function(i){t=i},this.push=function(i){var r=0,n=0,a,o,u,f;for(e.length?(f=e.length,e=new Uint8Array(i.byteLength+f),e.set(e.subarray(0,f)),e.set(i,f)):e=i;e.length-n>=3;){if(e[n]===73&&e[n+1]===68&&e[n+2]===51){if(e.length-n<10||(r=er.parseId3TagSize(e,n),n+r>e.length))break;o={type:"timed-metadata",data:e.subarray(n,n+r)},this.trigger("data",o),n+=r;continue}else if((e[n]&255)===255&&(e[n+1]&240)===240){if(e.length-n<7||(r=er.parseAdtsSize(e,n),n+r>e.length))break;u={type:"audio",data:e.subarray(n,n+r),pts:t,dts:t},this.trigger("data",u),n+=r;continue}n++}a=e.length-n,a>0?e=e.subarray(n):e=new Uint8Array},this.reset=function(){e=new Uint8Array,this.trigger("reset")},this.endTimeline=function(){e=new Uint8Array,this.trigger("endedtimeline")}},Xe.prototype=new sa;var tr=Xe,oa=["audioobjecttype","channelcount","samplerate","samplingfrequencyindex","samplesize"],ir=oa,ua=["width","height","profileIdc","levelIdc","profileCompatibility","sarRatio"],rr=ua,Ke=M,xe=Pe,ye=Gi,je=Wi,V=Re,G=Ye,Ze=Y,nr=Ae,la=ht.H264Stream,fa=tr,da=qe.isLikelyAacData,ha=Y.ONE_SECOND_IN_TS,ar=ir,sr=rr,ve,oe,Je,Q,pa=function(e,t){t.stream=e,this.trigger("log",t)},or=function(e,t){for(var i=Object.keys(t),r=0;r<i.length;r++){var n=i[r];n==="headOfPipeline"||!t[n].on||t[n].on("log",pa.bind(e,n))}},ur=function(e,t){var i;if(e.length!==t.length)return!1;for(i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0},lr=function(e,t,i,r,n,a){var o=i-t,u=r-t,f=n-i;return{start:{dts:e,pts:e+o},end:{dts:e+u,pts:e+f},prependedContentDuration:a,baseMediaDecodeTime:e}};oe=function(e,t){var i=[],r,n=0,a=0,o=1/0;t=t||{},r=t.firstSequenceNumber||0,oe.prototype.init.call(this),this.push=function(u){V.collectDtsInfo(e,u),e&&ar.forEach(function(f){e[f]=u[f]}),i.push(u)},this.setEarliestDts=function(u){n=u},this.setVideoBaseMediaDecodeTime=function(u){o=u},this.setAudioAppendStart=function(u){a=u},this.flush=function(){var u,f,l,d,h,m,p;if(i.length===0){this.trigger("done","AudioSegmentStream");return}u=je.trimAdtsFramesByEarliestDts(i,e,n),e.baseMediaDecodeTime=V.calculateTrackBaseMediaDecodeTime(e,t.keepOriginalTimestamps),p=je.prefixWithSilence(e,u,a,o),e.samples=je.generateSampleTable(u),l=xe.mdat(je.concatenateFrameData(u)),i=[],f=xe.moof(r,[e]),d=new Uint8Array(f.byteLength+l.byteLength),r++,d.set(f),d.set(l,f.byteLength),V.clearDtsInfo(e),h=Math.ceil(ha*1024/e.samplerate),u.length&&(m=u.length*h,this.trigger("segmentTimingInfo",lr(Ze.audioTsToVideoTs(e.baseMediaDecodeTime,e.samplerate),u[0].dts,u[0].pts,u[0].dts+m,u[0].pts+m,p||0)),this.trigger("timingInfo",{start:u[0].pts,end:u[0].pts+m})),this.trigger("data",{track:e,boxes:d}),this.trigger("done","AudioSegmentStream")},this.reset=function(){V.clearDtsInfo(e),i=[],this.trigger("reset")}},oe.prototype=new Ke,ve=function(e,t){var i,r=[],n=[],a,o;t=t||{},i=t.firstSequenceNumber||0,ve.prototype.init.call(this),delete e.minPTS,this.gopCache_=[],this.push=function(u){V.collectDtsInfo(e,u),u.nalUnitType==="seq_parameter_set_rbsp"&&!a&&(a=u.config,e.sps=[u.data],sr.forEach(function(f){e[f]=a[f]},this)),u.nalUnitType==="pic_parameter_set_rbsp"&&!o&&(o=u.data,e.pps=[u.data]),r.push(u)},this.flush=function(){for(var u,f,l,d,h,m,p=0,c,g;r.length&&r[0].nalUnitType!=="access_unit_delimiter_rbsp";)r.shift();if(r.length===0){this.resetStream_(),this.trigger("done","VideoSegmentStream");return}if(u=ye.groupNalsIntoFrames(r),l=ye.groupFramesIntoGops(u),l[0][0].keyFrame||(f=this.getGopForFusion_(r[0],e),f?(p=f.duration,l.unshift(f),l.byteLength+=f.byteLength,l.nalCount+=f.nalCount,l.pts=f.pts,l.dts=f.dts,l.duration+=f.duration):l=ye.extendFirstKeyFrame(l)),n.length){var w;if(t.alignGopsAtEnd?w=this.alignGopsAtEnd_(l):w=this.alignGopsAtStart_(l),!w){this.gopCache_.unshift({gop:l.pop(),pps:e.pps,sps:e.sps}),this.gopCache_.length=Math.min(6,this.gopCache_.length),r=[],this.resetStream_(),this.trigger("done","VideoSegmentStream");return}V.clearDtsInfo(e),l=w}V.collectDtsInfo(e,l),e.samples=ye.generateSampleTable(l),h=xe.mdat(ye.concatenateNalData(l)),e.baseMediaDecodeTime=V.calculateTrackBaseMediaDecodeTime(e,t.keepOriginalTimestamps),this.trigger("processedGopsInfo",l.map(function(F){return{pts:F.pts,dts:F.dts,byteLength:F.byteLength}})),c=l[0],g=l[l.length-1],this.trigger("segmentTimingInfo",lr(e.baseMediaDecodeTime,c.dts,c.pts,g.dts+g.duration,g.pts+g.duration,p)),this.trigger("timingInfo",{start:l[0].pts,end:l[l.length-1].pts+l[l.length-1].duration}),this.gopCache_.unshift({gop:l.pop(),pps:e.pps,sps:e.sps}),this.gopCache_.length=Math.min(6,this.gopCache_.length),r=[],this.trigger("baseMediaDecodeTime",e.baseMediaDecodeTime),this.trigger("timelineStartInfo",e.timelineStartInfo),d=xe.moof(i,[e]),m=new Uint8Array(d.byteLength+h.byteLength),i++,m.set(d),m.set(h,d.byteLength),this.trigger("data",{track:e,boxes:m}),this.resetStream_(),this.trigger("done","VideoSegmentStream")},this.reset=function(){this.resetStream_(),r=[],this.gopCache_.length=0,n.length=0,this.trigger("reset")},this.resetStream_=function(){V.clearDtsInfo(e),a=void 0,o=void 0},this.getGopForFusion_=function(u){var f=45e3,l=1/0,d,h,m,p,c;for(c=0;c<this.gopCache_.length;c++)p=this.gopCache_[c],m=p.gop,!(!(e.pps&&ur(e.pps[0],p.pps[0]))||!(e.sps&&ur(e.sps[0],p.sps[0])))&&(m.dts<e.timelineStartInfo.dts||(d=u.dts-m.dts-m.duration,d>=-1e4&&d<=f&&(!h||l>d)&&(h=p,l=d)));return h?h.gop:null},this.alignGopsAtStart_=function(u){var f,l,d,h,m,p,c,g;for(m=u.byteLength,p=u.nalCount,c=u.duration,f=l=0;f<n.length&&l<u.length&&(d=n[f],h=u[l],d.pts!==h.pts);){if(h.pts>d.pts){f++;continue}l++,m-=h.byteLength,p-=h.nalCount,c-=h.duration}return l===0?u:l===u.length?null:(g=u.slice(l),g.byteLength=m,g.duration=c,g.nalCount=p,g.pts=g[0].pts,g.dts=g[0].dts,g)},this.alignGopsAtEnd_=function(u){var f,l,d,h,m,p;for(f=n.length-1,l=u.length-1,m=null,p=!1;f>=0&&l>=0;){if(d=n[f],h=u[l],d.pts===h.pts){p=!0;break}if(d.pts>h.pts){f--;continue}f===n.length-1&&(m=l),l--}if(!p&&m===null)return null;var c;if(p?c=l:c=m,c===0)return u;var g=u.slice(c),w=g.reduce(function(F,H){return F.byteLength+=H.byteLength,F.duration+=H.duration,F.nalCount+=H.nalCount,F},{byteLength:0,duration:0,nalCount:0});return g.byteLength=w.byteLength,g.duration=w.duration,g.nalCount=w.nalCount,g.pts=g[0].pts,g.dts=g[0].dts,g},this.alignGopsWith=function(u){n=u}},ve.prototype=new Ke,Q=function(e,t){this.numberOfTracks=0,this.metadataStream=t,e=e||{},typeof e.remux<"u"?this.remuxTracks=!!e.remux:this.remuxTracks=!0,typeof e.keepOriginalTimestamps=="boolean"?this.keepOriginalTimestamps=e.keepOriginalTimestamps:this.keepOriginalTimestamps=!1,this.pendingTracks=[],this.videoTrack=null,this.pendingBoxes=[],this.pendingCaptions=[],this.pendingMetadata=[],this.pendingBytes=0,this.emittedTracks=0,Q.prototype.init.call(this),this.push=function(i){if(i.text)return this.pendingCaptions.push(i);if(i.frames)return this.pendingMetadata.push(i);this.pendingTracks.push(i.track),this.pendingBytes+=i.boxes.byteLength,i.track.type==="video"&&(this.videoTrack=i.track,this.pendingBoxes.push(i.boxes)),i.track.type==="audio"&&(this.audioTrack=i.track,this.pendingBoxes.unshift(i.boxes))}},Q.prototype=new Ke,Q.prototype.flush=function(s){var e=0,t={captions:[],captionStreams:{},metadata:[],info:{}},i,r,n,a=0,o;if(this.pendingTracks.length<this.numberOfTracks){if(s!=="VideoSegmentStream"&&s!=="AudioSegmentStream")return;if(this.remuxTracks)return;if(this.pendingTracks.length===0){this.emittedTracks++,this.emittedTracks>=this.numberOfTracks&&(this.trigger("done"),this.emittedTracks=0);return}}if(this.videoTrack?(a=this.videoTrack.timelineStartInfo.pts,sr.forEach(function(u){t.info[u]=this.videoTrack[u]},this)):this.audioTrack&&(a=this.audioTrack.timelineStartInfo.pts,ar.forEach(function(u){t.info[u]=this.audioTrack[u]},this)),this.videoTrack||this.audioTrack){for(this.pendingTracks.length===1?t.type=this.pendingTracks[0].type:t.type="combined",this.emittedTracks+=this.pendingTracks.length,n=xe.initSegment(this.pendingTracks),t.initSegment=new Uint8Array(n.byteLength),t.initSegment.set(n),t.data=new Uint8Array(this.pendingBytes),o=0;o<this.pendingBoxes.length;o++)t.data.set(this.pendingBoxes[o],e),e+=this.pendingBoxes[o].byteLength;for(o=0;o<this.pendingCaptions.length;o++)i=this.pendingCaptions[o],i.startTime=Ze.metadataTsToSeconds(i.startPts,a,this.keepOriginalTimestamps),i.endTime=Ze.metadataTsToSeconds(i.endPts,a,this.keepOriginalTimestamps),t.captionStreams[i.stream]=!0,t.captions.push(i);for(o=0;o<this.pendingMetadata.length;o++)r=this.pendingMetadata[o],r.cueTime=Ze.metadataTsToSeconds(r.pts,a,this.keepOriginalTimestamps),t.metadata.push(r);for(t.metadata.dispatchType=this.metadataStream.dispatchType,this.pendingTracks.length=0,this.videoTrack=null,this.pendingBoxes.length=0,this.pendingCaptions.length=0,this.pendingBytes=0,this.pendingMetadata.length=0,this.trigger("data",t),o=0;o<t.captions.length;o++)i=t.captions[o],this.trigger("caption",i);for(o=0;o<t.metadata.length;o++)r=t.metadata[o],this.trigger("id3Frame",r)}this.emittedTracks>=this.numberOfTracks&&(this.trigger("done"),this.emittedTracks=0)},Q.prototype.setRemux=function(s){this.remuxTracks=s},Je=function(e){var t=this,i=!0,r,n;Je.prototype.init.call(this),e=e||{},this.baseMediaDecodeTime=e.baseMediaDecodeTime||0,this.transmuxPipeline_={},this.setupAacPipeline=function(){var a={};this.transmuxPipeline_=a,a.type="aac",a.metadataStream=new G.MetadataStream,a.aacStream=new fa,a.audioTimestampRolloverStream=new G.TimestampRolloverStream("audio"),a.timedMetadataTimestampRolloverStream=new G.TimestampRolloverStream("timed-metadata"),a.adtsStream=new nr,a.coalesceStream=new Q(e,a.metadataStream),a.headOfPipeline=a.aacStream,a.aacStream.pipe(a.audioTimestampRolloverStream).pipe(a.adtsStream),a.aacStream.pipe(a.timedMetadataTimestampRolloverStream).pipe(a.metadataStream).pipe(a.coalesceStream),a.metadataStream.on("timestamp",function(o){a.aacStream.setTimestamp(o.timeStamp)}),a.aacStream.on("data",function(o){o.type!=="timed-metadata"&&o.type!=="audio"||a.audioSegmentStream||(n=n||{timelineStartInfo:{baseMediaDecodeTime:t.baseMediaDecodeTime},codec:"adts",type:"audio"},a.coalesceStream.numberOfTracks++,a.audioSegmentStream=new oe(n,e),a.audioSegmentStream.on("log",t.getLogTrigger_("audioSegmentStream")),a.audioSegmentStream.on("timingInfo",t.trigger.bind(t,"audioTimingInfo")),a.adtsStream.pipe(a.audioSegmentStream).pipe(a.coalesceStream),t.trigger("trackinfo",{hasAudio:!!n,hasVideo:!!r}))}),a.coalesceStream.on("data",this.trigger.bind(this,"data")),a.coalesceStream.on("done",this.trigger.bind(this,"done")),or(this,a)},this.setupTsPipeline=function(){var a={};this.transmuxPipeline_=a,a.type="ts",a.metadataStream=new G.MetadataStream,a.packetStream=new G.TransportPacketStream,a.parseStream=new G.TransportParseStream,a.elementaryStream=new G.ElementaryStream,a.timestampRolloverStream=new G.TimestampRolloverStream,a.adtsStream=new nr,a.h264Stream=new la,a.captionStream=new G.CaptionStream(e),a.coalesceStream=new Q(e,a.metadataStream),a.headOfPipeline=a.packetStream,a.packetStream.pipe(a.parseStream).pipe(a.elementaryStream).pipe(a.timestampRolloverStream),a.timestampRolloverStream.pipe(a.h264Stream),a.timestampRolloverStream.pipe(a.adtsStream),a.timestampRolloverStream.pipe(a.metadataStream).pipe(a.coalesceStream),a.h264Stream.pipe(a.captionStream).pipe(a.coalesceStream),a.elementaryStream.on("data",function(o){var u;if(o.type==="metadata"){for(u=o.tracks.length;u--;)!r&&o.tracks[u].type==="video"?(r=o.tracks[u],r.timelineStartInfo.baseMediaDecodeTime=t.baseMediaDecodeTime):!n&&o.tracks[u].type==="audio"&&(n=o.tracks[u],n.timelineStartInfo.baseMediaDecodeTime=t.baseMediaDecodeTime);r&&!a.videoSegmentStream&&(a.coalesceStream.numberOfTracks++,a.videoSegmentStream=new ve(r,e),a.videoSegmentStream.on("log",t.getLogTrigger_("videoSegmentStream")),a.videoSegmentStream.on("timelineStartInfo",function(f){n&&!e.keepOriginalTimestamps&&(n.timelineStartInfo=f,a.audioSegmentStream.setEarliestDts(f.dts-t.baseMediaDecodeTime))}),a.videoSegmentStream.on("processedGopsInfo",t.trigger.bind(t,"gopInfo")),a.videoSegmentStream.on("segmentTimingInfo",t.trigger.bind(t,"videoSegmentTimingInfo")),a.videoSegmentStream.on("baseMediaDecodeTime",function(f){n&&a.audioSegmentStream.setVideoBaseMediaDecodeTime(f)}),a.videoSegmentStream.on("timingInfo",t.trigger.bind(t,"videoTimingInfo")),a.h264Stream.pipe(a.videoSegmentStream).pipe(a.coalesceStream)),n&&!a.audioSegmentStream&&(a.coalesceStream.numberOfTracks++,a.audioSegmentStream=new oe(n,e),a.audioSegmentStream.on("log",t.getLogTrigger_("audioSegmentStream")),a.audioSegmentStream.on("timingInfo",t.trigger.bind(t,"audioTimingInfo")),a.audioSegmentStream.on("segmentTimingInfo",t.trigger.bind(t,"audioSegmentTimingInfo")),a.adtsStream.pipe(a.audioSegmentStream).pipe(a.coalesceStream)),t.trigger("trackinfo",{hasAudio:!!n,hasVideo:!!r})}}),a.coalesceStream.on("data",this.trigger.bind(this,"data")),a.coalesceStream.on("id3Frame",function(o){o.dispatchType=a.metadataStream.dispatchType,t.trigger("id3Frame",o)}),a.coalesceStream.on("caption",this.trigger.bind(this,"caption")),a.coalesceStream.on("done",this.trigger.bind(this,"done")),or(this,a)},this.setBaseMediaDecodeTime=function(a){var o=this.transmuxPipeline_;e.keepOriginalTimestamps||(this.baseMediaDecodeTime=a),n&&(n.timelineStartInfo.dts=void 0,n.timelineStartInfo.pts=void 0,V.clearDtsInfo(n),o.audioTimestampRolloverStream&&o.audioTimestampRolloverStream.discontinuity()),r&&(o.videoSegmentStream&&(o.videoSegmentStream.gopCache_=[]),r.timelineStartInfo.dts=void 0,r.timelineStartInfo.pts=void 0,V.clearDtsInfo(r),o.captionStream.reset()),o.timestampRolloverStream&&o.timestampRolloverStream.discontinuity()},this.setAudioAppendStart=function(a){n&&this.transmuxPipeline_.audioSegmentStream.setAudioAppendStart(a)},this.setRemux=function(a){var o=this.transmuxPipeline_;e.remux=a,o&&o.coalesceStream&&o.coalesceStream.setRemux(a)},this.alignGopsWith=function(a){r&&this.transmuxPipeline_.videoSegmentStream&&this.transmuxPipeline_.videoSegmentStream.alignGopsWith(a)},this.getLogTrigger_=function(a){var o=this;return function(u){u.stream=a,o.trigger("log",u)}},this.push=function(a){if(i){var o=da(a);o&&this.transmuxPipeline_.type!=="aac"?this.setupAacPipeline():!o&&this.transmuxPipeline_.type!=="ts"&&this.setupTsPipeline(),i=!1}this.transmuxPipeline_.headOfPipeline.push(a)},this.flush=function(){i=!0,this.transmuxPipeline_.headOfPipeline.flush()},this.endTimeline=function(){this.transmuxPipeline_.headOfPipeline.endTimeline()},this.reset=function(){this.transmuxPipeline_.headOfPipeline&&this.transmuxPipeline_.headOfPipeline.reset()},this.resetCaptions=function(){this.transmuxPipeline_.captionStream&&this.transmuxPipeline_.captionStream.reset()}},Je.prototype=new Ke;var Ot={Transmuxer:Je,VideoSegmentStream:ve,AudioSegmentStream:oe},ma=Yi.discardEmulationPreventionBytes,ca=qi.CaptionStream,Se=yt,ga=Tt,xa=St,ya=vt,fr=Oi,va=function(e,t){for(var i=e,r=0;r<t.length;r++){var n=t[r];if(i<n.size)return n;i-=n.size}return null},Sa=function(e,t,i){var r=new DataView(e.buffer,e.byteOffset,e.byteLength),n={logs:[],seiNals:[]},a,o,u,f;for(o=0;o+4<e.length;o+=u)if(u=r.getUint32(o),o+=4,!(u<=0))switch(e[o]&31){case 6:var l=e.subarray(o+1,o+1+u),d=va(o,t);if(a={nalUnitType:"sei_rbsp",size:u,data:l,escapedRBSP:ma(l),trackId:i},d)a.pts=d.pts,a.dts=d.dts,f=d;else if(f)a.pts=f.pts,a.dts=f.dts;else{n.logs.push({level:"warn",message:"We've encountered a nal unit without data at "+o+" for trackId "+i+". See mux.js#223."});break}n.seiNals.push(a);break}return n},Ta=function(e,t,i){var r=t,n=i.defaultSampleDuration||0,a=i.defaultSampleSize||0,o=i.trackId,u=[];return e.forEach(function(f){var l=xa(f),d=l.samples;d.forEach(function(h){h.duration===void 0&&(h.duration=n),h.size===void 0&&(h.size=a),h.trackId=o,h.dts=r,h.compositionTimeOffset===void 0&&(h.compositionTimeOffset=0),typeof r=="bigint"?(h.pts=r+fr.BigInt(h.compositionTimeOffset),r+=fr.BigInt(h.duration)):(h.pts=r+h.compositionTimeOffset,r+=h.duration)}),u=u.concat(d)}),u},ba=function(e,t){var i=Se(e,["moof","traf"]),r=Se(e,["mdat"]),n={},a=[];return r.forEach(function(o,u){var f=i[u];a.push({mdat:o,traf:f})}),a.forEach(function(o){var u=o.mdat,f=o.traf,l=Se(f,["tfhd"]),d=ya(l[0]),h=d.trackId,m=Se(f,["tfdt"]),p=m.length>0?ga(m[0]).baseMediaDecodeTime:0,c=Se(f,["trun"]),g,w;t===h&&c.length>0&&(g=Ta(c,p,d),w=Sa(u,g,h),n[h]||(n[h]={seiNals:[],logs:[]}),n[h].seiNals=n[h].seiNals.concat(w.seiNals),n[h].logs=n[h].logs.concat(w.logs))}),n},wa=function(e,t,i){var r;if(t===null)return null;r=ba(e,t);var n=r[t]||{};return{seiNals:n.seiNals,logs:n.logs,timescale:i}},_a=function(){var e=!1,t,i,r,n,a,o;this.isInitialized=function(){return e},this.init=function(u){t=new ca,e=!0,o=u?u.isPartial:!1,t.on("data",function(f){f.startTime=f.startPts/n,f.endTime=f.endPts/n,a.captions.push(f),a.captionStreams[f.stream]=!0}),t.on("log",function(f){a.logs.push(f)})},this.isNewInit=function(u,f){return u&&u.length===0||f&&typeof f=="object"&&Object.keys(f).length===0?!1:r!==u[0]||n!==f[r]},this.parse=function(u,f,l){var d;if(this.isInitialized()){if(!f||!l)return null;if(this.isNewInit(f,l))r=f[0],n=l[r];else if(r===null||!n)return i.push(u),null}else return null;for(;i.length>0;){var h=i.shift();this.parse(h,f,l)}return d=wa(u,r,n),d&&d.logs&&(a.logs=a.logs.concat(d.logs)),d===null||!d.seiNals?a.logs.length?{logs:a.logs,captions:[],captionStreams:[]}:null:(this.pushNals(d.seiNals),this.flushStream(),a)},this.pushNals=function(u){if(!this.isInitialized()||!u||u.length===0)return null;u.forEach(function(f){t.push(f)})},this.flushStream=function(){if(!this.isInitialized())return null;o?t.partialFlush():t.flush()},this.clearParsedCaptions=function(){a.captions=[],a.captionStreams={},a.logs=[]},this.resetCaptionStream=function(){if(!this.isInitialized())return null;t.reset()},this.clearAllCaptions=function(){this.clearParsedCaptions(),this.resetCaptionStream()},this.reset=function(){i=[],r=null,n=null,a?this.clearParsedCaptions():a={captions:[],captionStreams:{},logs:[]},this.resetCaptionStream()},this.reset()},Fa=_a,Aa={generator:Pe,probe:mn,Transmuxer:Ot.Transmuxer,AudioSegmentStream:Ot.AudioSegmentStream,VideoSegmentStream:Ot.VideoSegmentStream,CaptionParser:Fa},S;S=function(e,t){var i=0,r=16384,n=function(d,h){var m,p=d.position+h;p<d.bytes.byteLength||(m=new Uint8Array(p*2),m.set(d.bytes.subarray(0,d.position),0),d.bytes=m,d.view=new DataView(d.bytes.buffer))},a=S.widthBytes||new Uint8Array(5),o=S.heightBytes||new Uint8Array(6),u=S.videocodecidBytes||new Uint8Array(12),f;if(!S.widthBytes){for(f=0;f<5;f++)a[f]="width".charCodeAt(f);for(f=0;f<6;f++)o[f]="height".charCodeAt(f);for(f=0;f<12;f++)u[f]="videocodecid".charCodeAt(f);S.widthBytes=a,S.heightBytes=o,S.videocodecidBytes=u}switch(this.keyFrame=!1,e){case S.VIDEO_TAG:this.length=16,r*=6;break;case S.AUDIO_TAG:this.length=13,this.keyFrame=!0;break;case S.METADATA_TAG:this.length=29,this.keyFrame=!0;break;default:throw new Error("Unknown FLV tag type")}this.bytes=new Uint8Array(r),this.view=new DataView(this.bytes.buffer),this.bytes[0]=e,this.position=this.length,this.keyFrame=t,this.pts=0,this.dts=0,this.writeBytes=function(l,d,h){var m=d||0,p;h=h||l.byteLength,p=m+h,n(this,h),this.bytes.set(l.subarray(m,p),this.position),this.position+=h,this.length=Math.max(this.length,this.position)},this.writeByte=function(l){n(this,1),this.bytes[this.position]=l,this.position++,this.length=Math.max(this.length,this.position)},this.writeShort=function(l){n(this,2),this.view.setUint16(this.position,l),this.position+=2,this.length=Math.max(this.length,this.position)},this.negIndex=function(l){return this.bytes[this.length-l]},this.nalUnitSize=function(){return i===0?0:this.length-(i+4)},this.startNalUnit=function(){if(i>0)throw new Error("Attempted to create new NAL wihout closing the old one");i=this.length,this.length+=4,this.position=this.length},this.endNalUnit=function(l){var d,h;this.length===i+4?this.length-=4:i>0&&(d=i+4,h=this.length-d,this.position=i,this.view.setUint32(this.position,h),this.position=this.length,l&&l.push(this.bytes.subarray(d,d+h))),i=0},this.writeMetaDataDouble=function(l,d){var h;if(n(this,2+l.length+9),this.view.setUint16(this.position,l.length),this.position+=2,l==="width")this.bytes.set(a,this.position),this.position+=5;else if(l==="height")this.bytes.set(o,this.position),this.position+=6;else if(l==="videocodecid")this.bytes.set(u,this.position),this.position+=12;else for(h=0;h<l.length;h++)this.bytes[this.position]=l.charCodeAt(h),this.position++;this.position++,this.view.setFloat64(this.position,d),this.position+=8,this.length=Math.max(this.length,this.position),++i},this.writeMetaDataBoolean=function(l,d){var h;for(n(this,2),this.view.setUint16(this.position,l.length),this.position+=2,h=0;h<l.length;h++)n(this,1),this.bytes[this.position]=l.charCodeAt(h),this.position++;n(this,2),this.view.setUint8(this.position,1),this.position++,this.view.setUint8(this.position,d?1:0),this.position++,this.length=Math.max(this.length,this.position),++i},this.finalize=function(){var l,d;switch(this.bytes[0]){case S.VIDEO_TAG:this.bytes[11]=(this.keyFrame||t?16:32)|7,this.bytes[12]=t?0:1,l=this.pts-this.dts,this.bytes[13]=(l&16711680)>>>16,this.bytes[14]=(l&65280)>>>8,this.bytes[15]=(l&255)>>>0;break;case S.AUDIO_TAG:this.bytes[11]=175,this.bytes[12]=t?0:1;break;case S.METADATA_TAG:this.position=11,this.view.setUint8(this.position,2),this.position++,this.view.setUint16(this.position,10),this.position+=2,this.bytes.set([111,110,77,101,116,97,68,97,116,97],this.position),this.position+=10,this.bytes[this.position]=8,this.position++,this.view.setUint32(this.position,i),this.position=this.length,this.bytes.set([0,0,9],this.position),this.position+=3,this.length=this.position;break}return d=this.length-11,this.bytes[1]=(d&16711680)>>>16,this.bytes[2]=(d&65280)>>>8,this.bytes[3]=(d&255)>>>0,this.bytes[4]=(this.dts&16711680)>>>16,this.bytes[5]=(this.dts&65280)>>>8,this.bytes[6]=(this.dts&255)>>>0,this.bytes[7]=(this.dts&4278190080)>>>24,this.bytes[8]=0,this.bytes[9]=0,this.bytes[10]=0,n(this,4),this.view.setUint32(this.length,this.length),this.length+=4,this.position+=4,this.bytes=this.bytes.subarray(0,this.length),this.frameTime=S.frameTime(this.bytes),this}},S.AUDIO_TAG=8,S.VIDEO_TAG=9,S.METADATA_TAG=18,S.isAudioFrame=function(s){return S.AUDIO_TAG===s[0]},S.isVideoFrame=function(s){return S.VIDEO_TAG===s[0]},S.isMetaData=function(s){return S.METADATA_TAG===s[0]},S.isKeyFrame=function(s){return S.isVideoFrame(s)?s[11]===23:!!(S.isAudioFrame(s)||S.isMetaData(s))},S.frameTime=function(s){var e=s[4]<<16;return e|=s[5]<<8,e|=s[6]<<0,e|=s[7]<<24,e};var Lt=S,Da=M,Mt=function s(e){this.numberOfTracks=0,this.metadataStream=e.metadataStream,this.videoTags=[],this.audioTags=[],this.videoTrack=null,this.audioTrack=null,this.pendingCaptions=[],this.pendingMetadata=[],this.pendingTracks=0,this.processedTracks=0,s.prototype.init.call(this),this.push=function(t){if(t.text)return this.pendingCaptions.push(t);if(t.frames)return this.pendingMetadata.push(t);t.track.type==="video"&&(this.videoTrack=t.track,this.videoTags=t.tags,this.pendingTracks++),t.track.type==="audio"&&(this.audioTrack=t.track,this.audioTags=t.tags,this.pendingTracks++)}};Mt.prototype=new Da,Mt.prototype.flush=function(s){var e,t,i,r,n={tags:{},captions:[],captionStreams:{},metadata:[]};if(this.pendingTracks<this.numberOfTracks){if(s!=="VideoSegmentStream"&&s!=="AudioSegmentStream")return;if(this.pendingTracks===0&&(this.processedTracks++,this.processedTracks<this.numberOfTracks))return}if(this.processedTracks+=this.pendingTracks,this.pendingTracks=0,!(this.processedTracks<this.numberOfTracks)){for(this.videoTrack?r=this.videoTrack.timelineStartInfo.pts:this.audioTrack&&(r=this.audioTrack.timelineStartInfo.pts),n.tags.videoTags=this.videoTags,n.tags.audioTags=this.audioTags,i=0;i<this.pendingCaptions.length;i++)t=this.pendingCaptions[i],t.startTime=t.startPts-r,t.startTime/=9e4,t.endTime=t.endPts-r,t.endTime/=9e4,n.captionStreams[t.stream]=!0,n.captions.push(t);for(i=0;i<this.pendingMetadata.length;i++)e=this.pendingMetadata[i],e.cueTime=e.pts-r,e.cueTime/=9e4,n.metadata.push(e);n.metadata.dispatchType=this.metadataStream.dispatchType,this.videoTrack=null,this.audioTrack=null,this.videoTags=[],this.audioTags=[],this.pendingCaptions.length=0,this.pendingMetadata.length=0,this.pendingTracks=0,this.processedTracks=0,this.trigger("data",n),this.trigger("done")}};var Ua=Mt,Pa=function(){var e=this;this.list=[],this.push=function(t){this.list.push({bytes:t.bytes,dts:t.dts,pts:t.pts,keyFrame:t.keyFrame,metaDataTag:t.metaDataTag})},Object.defineProperty(this,"length",{get:function(){return e.list.length}})},Ca=Pa,Rt=M,N=Lt,K=Ye,Ia=Ae,Ea=ht.H264Stream,Oa=Ua,dr=Ca,Qe,et,tt,Nt,hr,pr;Nt=function(e,t){typeof t.pts=="number"&&(e.timelineStartInfo.pts===void 0?e.timelineStartInfo.pts=t.pts:e.timelineStartInfo.pts=Math.min(e.timelineStartInfo.pts,t.pts)),typeof t.dts=="number"&&(e.timelineStartInfo.dts===void 0?e.timelineStartInfo.dts=t.dts:e.timelineStartInfo.dts=Math.min(e.timelineStartInfo.dts,t.dts))},hr=function(e,t){var i=new N(N.METADATA_TAG);return i.dts=t,i.pts=t,i.writeMetaDataDouble("videocodecid",7),i.writeMetaDataDouble("width",e.width),i.writeMetaDataDouble("height",e.height),i},pr=function(e,t){var i,r=new N(N.VIDEO_TAG,!0);for(r.dts=t,r.pts=t,r.writeByte(1),r.writeByte(e.profileIdc),r.writeByte(e.profileCompatibility),r.writeByte(e.levelIdc),r.writeByte(255),r.writeByte(225),r.writeShort(e.sps[0].length),r.writeBytes(e.sps[0]),r.writeByte(e.pps.length),i=0;i<e.pps.length;++i)r.writeShort(e.pps[i].length),r.writeBytes(e.pps[i]);return r},tt=function(e){var t=[],i=[],r;tt.prototype.init.call(this),this.push=function(n){Nt(e,n),e&&(e.audioobjecttype=n.audioobjecttype,e.channelcount=n.channelcount,e.samplerate=n.samplerate,e.samplingfrequencyindex=n.samplingfrequencyindex,e.samplesize=n.samplesize,e.extraData=e.audioobjecttype<<11|e.samplingfrequencyindex<<7|e.channelcount<<3),n.pts=Math.round(n.pts/90),n.dts=Math.round(n.dts/90),t.push(n)},this.flush=function(){var n,a,o,u=new dr;if(t.length===0){this.trigger("done","AudioSegmentStream");return}for(o=-1/0;t.length;)n=t.shift(),i.length&&n.pts>=i[0]&&(o=i.shift(),this.writeMetaDataTags(u,o)),(e.extraData!==r||n.pts-o>=1e3)&&(this.writeMetaDataTags(u,n.pts),r=e.extraData,o=n.pts),a=new N(N.AUDIO_TAG),a.pts=n.pts,a.dts=n.dts,a.writeBytes(n.data),u.push(a.finalize());i.length=0,r=null,this.trigger("data",{track:e,tags:u.list}),this.trigger("done","AudioSegmentStream")},this.writeMetaDataTags=function(n,a){var o;o=new N(N.METADATA_TAG),o.pts=a,o.dts=a,o.writeMetaDataDouble("audiocodecid",10),o.writeMetaDataBoolean("stereo",e.channelcount===2),o.writeMetaDataDouble("audiosamplerate",e.samplerate),o.writeMetaDataDouble("audiosamplesize",16),n.push(o.finalize()),o=new N(N.AUDIO_TAG,!0),o.pts=a,o.dts=a,o.view.setUint16(o.position,e.extraData),o.position+=2,o.length=Math.max(o.length,o.position),n.push(o.finalize())},this.onVideoKeyFrame=function(n){i.push(n)}},tt.prototype=new Rt,et=function(e){var t=[],i,r;et.prototype.init.call(this),this.finishFrame=function(n,a){if(a){if(i&&e&&e.newMetadata&&(a.keyFrame||n.length===0)){var o=hr(i,a.dts).finalize(),u=pr(e,a.dts).finalize();o.metaDataTag=u.metaDataTag=!0,n.push(o),n.push(u),e.newMetadata=!1,this.trigger("keyframe",a.dts)}a.endNalUnit(),n.push(a.finalize()),r=null}},this.push=function(n){Nt(e,n),n.pts=Math.round(n.pts/90),n.dts=Math.round(n.dts/90),t.push(n)},this.flush=function(){for(var n,a=new dr;t.length&&t[0].nalUnitType!=="access_unit_delimiter_rbsp";)t.shift();if(t.length===0){this.trigger("done","VideoSegmentStream");return}for(;t.length;)n=t.shift(),n.nalUnitType==="seq_parameter_set_rbsp"?(e.newMetadata=!0,i=n.config,e.width=i.width,e.height=i.height,e.sps=[n.data],e.profileIdc=i.profileIdc,e.levelIdc=i.levelIdc,e.profileCompatibility=i.profileCompatibility,r.endNalUnit()):n.nalUnitType==="pic_parameter_set_rbsp"?(e.newMetadata=!0,e.pps=[n.data],r.endNalUnit()):n.nalUnitType==="access_unit_delimiter_rbsp"?(r&&this.finishFrame(a,r),r=new N(N.VIDEO_TAG),r.pts=n.pts,r.dts=n.dts):(n.nalUnitType==="slice_layer_without_partitioning_rbsp_idr"&&(r.keyFrame=!0),r.endNalUnit()),r.startNalUnit(),r.writeBytes(n.data);r&&this.finishFrame(a,r),this.trigger("data",{track:e,tags:a.list}),this.trigger("done","VideoSegmentStream")}},et.prototype=new Rt,Qe=function(e){var t=this,i,r,n,a,o,u,f,l,d,h,m,p;Qe.prototype.init.call(this),e=e||{},this.metadataStream=new K.MetadataStream,e.metadataStream=this.metadataStream,i=new K.TransportPacketStream,r=new K.TransportParseStream,n=new K.ElementaryStream,a=new K.TimestampRolloverStream("video"),o=new K.TimestampRolloverStream("audio"),u=new K.TimestampRolloverStream("timed-metadata"),f=new Ia,l=new Ea,p=new Oa(e),i.pipe(r).pipe(n),n.pipe(a).pipe(l),n.pipe(o).pipe(f),n.pipe(u).pipe(this.metadataStream).pipe(p),m=new K.CaptionStream(e),l.pipe(m).pipe(p),n.on("data",function(c){var g,w,F;if(c.type==="metadata"){for(g=c.tracks.length;g--;)c.tracks[g].type==="video"?w=c.tracks[g]:c.tracks[g].type==="audio"&&(F=c.tracks[g]);w&&!d&&(p.numberOfTracks++,d=new et(w),l.pipe(d).pipe(p)),F&&!h&&(p.numberOfTracks++,h=new tt(F),f.pipe(h).pipe(p),d&&d.on("keyframe",h.onVideoKeyFrame))}}),this.push=function(c){i.push(c)},this.flush=function(){i.flush()},this.resetCaptions=function(){m.reset()},p.on("data",function(c){t.trigger("data",c)}),p.on("done",function(){t.trigger("done")})},Qe.prototype=new Rt;var La=Qe,mr=Lt,Ma=function(e,t,i){var r=new Uint8Array(9),n=new DataView(r.buffer),a,o,u;return e=e||0,t=t===void 0?!0:t,i=i===void 0?!0:i,n.setUint8(0,70),n.setUint8(1,76),n.setUint8(2,86),n.setUint8(3,1),n.setUint8(4,(t?4:0)|(i?1:0)),n.setUint32(5,r.byteLength),e<=0?(o=new Uint8Array(r.byteLength+4),o.set(r),o.set([0,0,0,0],r.byteLength),o):(a=new mr(mr.METADATA_TAG),a.pts=a.dts=0,a.writeMetaDataDouble("duration",e),u=a.finalize().length,o=new Uint8Array(r.byteLength+u),o.set(r),o.set(n.byteLength,u),o)},Ra=Ma,Na={tag:Lt,Transmuxer:La,getFlvHeader:Ra},ka=Ye,Ba=M,kt=Pe,it=Wi,rt=Re,Va=Y.ONE_SECOND_IN_TS,$a=ir,cr=function s(e,t){var i=[],r=0,n=0,a=0,o=1/0,u=null,f=null;t=t||{},s.prototype.init.call(this),this.push=function(l){rt.collectDtsInfo(e,l),e&&$a.forEach(function(d){e[d]=l[d]}),i.push(l)},this.setEarliestDts=function(l){n=l},this.setVideoBaseMediaDecodeTime=function(l){o=l},this.setAudioAppendStart=function(l){a=l},this.processFrames_=function(){var l,d,h,m,p;i.length!==0&&(l=it.trimAdtsFramesByEarliestDts(i,e,n),l.length!==0&&(e.baseMediaDecodeTime=rt.calculateTrackBaseMediaDecodeTime(e,t.keepOriginalTimestamps),it.prefixWithSilence(e,l,a,o),e.samples=it.generateSampleTable(l),h=kt.mdat(it.concatenateFrameData(l)),i=[],d=kt.moof(r,[e]),r++,e.initSegment=kt.initSegment([e]),m=new Uint8Array(d.byteLength+h.byteLength),m.set(d),m.set(h,d.byteLength),rt.clearDtsInfo(e),u===null&&(f=u=l[0].pts),f+=l.length*(Va*1024/e.samplerate),p={start:u},this.trigger("timingInfo",p),this.trigger("data",{track:e,boxes:m})))},this.flush=function(){this.processFrames_(),this.trigger("timingInfo",{start:u,end:f}),this.resetTiming_(),this.trigger("done","AudioSegmentStream")},this.partialFlush=function(){this.processFrames_(),this.trigger("partialdone","AudioSegmentStream")},this.endTimeline=function(){this.flush(),this.trigger("endedtimeline","AudioSegmentStream")},this.resetTiming_=function(){rt.clearDtsInfo(e),u=null,f=null},this.reset=function(){this.resetTiming_(),i=[],this.trigger("reset")}};cr.prototype=new Ba;var za=cr,Ga=M,Bt=Pe,nt=Re,Te=Gi,Wa=rr,gr=function s(e,t){var i=0,r=[],n=[],a,o,u=null,f=null,l,d=!0;t=t||{},s.prototype.init.call(this),this.push=function(h){nt.collectDtsInfo(e,h),typeof e.timelineStartInfo.dts>"u"&&(e.timelineStartInfo.dts=h.dts),h.nalUnitType==="seq_parameter_set_rbsp"&&!a&&(a=h.config,e.sps=[h.data],Wa.forEach(function(m){e[m]=a[m]},this)),h.nalUnitType==="pic_parameter_set_rbsp"&&!o&&(o=h.data,e.pps=[h.data]),r.push(h)},this.processNals_=function(h){var m;for(r=n.concat(r);r.length&&r[0].nalUnitType!=="access_unit_delimiter_rbsp";)r.shift();if(r.length!==0){var p=Te.groupNalsIntoFrames(r);if(p.length){if(n=p[p.length-1],h&&(p.pop(),p.duration-=n.duration,p.nalCount-=n.length,p.byteLength-=n.byteLength),!p.length){r=[];return}if(this.trigger("timelineStartInfo",e.timelineStartInfo),d){if(l=Te.groupFramesIntoGops(p),!l[0][0].keyFrame){if(l=Te.extendFirstKeyFrame(l),!l[0][0].keyFrame){r=[].concat.apply([],p).concat(n),n=[];return}p=[].concat.apply([],l),p.duration=l.duration}d=!1}for(u===null&&(u=p[0].pts,f=u),f+=p.duration,this.trigger("timingInfo",{start:u,end:f}),m=0;m<p.length;m++){var c=p[m];e.samples=Te.generateSampleTableForFrame(c);var g=Bt.mdat(Te.concatenateNalDataForFrame(c));nt.clearDtsInfo(e),nt.collectDtsInfo(e,c),e.baseMediaDecodeTime=nt.calculateTrackBaseMediaDecodeTime(e,t.keepOriginalTimestamps);var w=Bt.moof(i,[e]);i++,e.initSegment=Bt.initSegment([e]);var F=new Uint8Array(w.byteLength+g.byteLength);F.set(w),F.set(g,w.byteLength),this.trigger("data",{track:e,boxes:F,sequence:i,videoFrameDts:c.dts,videoFramePts:c.pts})}r=[]}}},this.resetTimingAndConfig_=function(){a=void 0,o=void 0,u=null,f=null},this.partialFlush=function(){this.processNals_(!0),this.trigger("partialdone","VideoSegmentStream")},this.flush=function(){this.processNals_(!1),this.resetTimingAndConfig_(),this.trigger("done","VideoSegmentStream")},this.endTimeline=function(){this.flush(),this.trigger("endedtimeline","VideoSegmentStream")},this.reset=function(){this.resetTimingAndConfig_(),n=[],r=[],d=!0,this.trigger("reset")}};gr.prototype=new Ga;var Ha=gr,xr=M,W=Ye,yr=Qt,vr=za,Ya=Ha,Sr=Re,qa=qe.isLikelyAacData,Xa=Ae,Ka=tr,Vt=Y,Tr=function(e){return e.prototype=new xr,e.prototype.init.call(e),e},ja=function(e){var t={type:"ts",tracks:{audio:null,video:null},packet:new W.TransportPacketStream,parse:new W.TransportParseStream,elementary:new W.ElementaryStream,timestampRollover:new W.TimestampRolloverStream,adts:new yr.Adts,h264:new yr.h264.H264Stream,captionStream:new W.CaptionStream(e),metadataStream:new W.MetadataStream};return t.headOfPipeline=t.packet,t.packet.pipe(t.parse).pipe(t.elementary).pipe(t.timestampRollover),t.timestampRollover.pipe(t.h264),t.h264.pipe(t.captionStream),t.timestampRollover.pipe(t.metadataStream),t.timestampRollover.pipe(t.adts),t.elementary.on("data",function(i){if(i.type==="metadata"){for(var r=0;r<i.tracks.length;r++)t.tracks[i.tracks[r].type]||(t.tracks[i.tracks[r].type]=i.tracks[r],t.tracks[i.tracks[r].type].timelineStartInfo.baseMediaDecodeTime=e.baseMediaDecodeTime);t.tracks.video&&!t.videoSegmentStream&&(t.videoSegmentStream=new Ya(t.tracks.video,e),t.videoSegmentStream.on("timelineStartInfo",function(n){t.tracks.audio&&!e.keepOriginalTimestamps&&t.audioSegmentStream.setEarliestDts(n.dts-e.baseMediaDecodeTime)}),t.videoSegmentStream.on("timingInfo",t.trigger.bind(t,"videoTimingInfo")),t.videoSegmentStream.on("data",function(n){t.trigger("data",{type:"video",data:n})}),t.videoSegmentStream.on("done",t.trigger.bind(t,"done")),t.videoSegmentStream.on("partialdone",t.trigger.bind(t,"partialdone")),t.videoSegmentStream.on("endedtimeline",t.trigger.bind(t,"endedtimeline")),t.h264.pipe(t.videoSegmentStream)),t.tracks.audio&&!t.audioSegmentStream&&(t.audioSegmentStream=new vr(t.tracks.audio,e),t.audioSegmentStream.on("data",function(n){t.trigger("data",{type:"audio",data:n})}),t.audioSegmentStream.on("done",t.trigger.bind(t,"done")),t.audioSegmentStream.on("partialdone",t.trigger.bind(t,"partialdone")),t.audioSegmentStream.on("endedtimeline",t.trigger.bind(t,"endedtimeline")),t.audioSegmentStream.on("timingInfo",t.trigger.bind(t,"audioTimingInfo")),t.adts.pipe(t.audioSegmentStream)),t.trigger("trackinfo",{hasAudio:!!t.tracks.audio,hasVideo:!!t.tracks.video})}}),t.captionStream.on("data",function(i){var r;t.tracks.video?r=t.tracks.video.timelineStartInfo.pts||0:r=0,i.startTime=Vt.metadataTsToSeconds(i.startPts,r,e.keepOriginalTimestamps),i.endTime=Vt.metadataTsToSeconds(i.endPts,r,e.keepOriginalTimestamps),t.trigger("caption",i)}),t=Tr(t),t.metadataStream.on("data",t.trigger.bind(t,"id3Frame")),t},Za=function(e){var t={type:"aac",tracks:{audio:null},metadataStream:new W.MetadataStream,aacStream:new Ka,audioRollover:new W.TimestampRolloverStream("audio"),timedMetadataRollover:new W.TimestampRolloverStream("timed-metadata"),adtsStream:new Xa(!0)};return t.headOfPipeline=t.aacStream,t.aacStream.pipe(t.audioRollover).pipe(t.adtsStream),t.aacStream.pipe(t.timedMetadataRollover).pipe(t.metadataStream),t.metadataStream.on("timestamp",function(i){t.aacStream.setTimestamp(i.timeStamp)}),t.aacStream.on("data",function(i){i.type!=="timed-metadata"&&i.type!=="audio"||t.audioSegmentStream||(t.tracks.audio=t.tracks.audio||{timelineStartInfo:{baseMediaDecodeTime:e.baseMediaDecodeTime},codec:"adts",type:"audio"},t.audioSegmentStream=new vr(t.tracks.audio,e),t.audioSegmentStream.on("data",function(r){t.trigger("data",{type:"audio",data:r})}),t.audioSegmentStream.on("partialdone",t.trigger.bind(t,"partialdone")),t.audioSegmentStream.on("done",t.trigger.bind(t,"done")),t.audioSegmentStream.on("endedtimeline",t.trigger.bind(t,"endedtimeline")),t.audioSegmentStream.on("timingInfo",t.trigger.bind(t,"audioTimingInfo")),t.adtsStream.pipe(t.audioSegmentStream),t.trigger("trackinfo",{hasAudio:!!t.tracks.audio,hasVideo:!!t.tracks.video}))}),t=Tr(t),t.metadataStream.on("data",t.trigger.bind(t,"id3Frame")),t},br=function(e,t){e.on("data",t.trigger.bind(t,"data")),e.on("done",t.trigger.bind(t,"done")),e.on("partialdone",t.trigger.bind(t,"partialdone")),e.on("endedtimeline",t.trigger.bind(t,"endedtimeline")),e.on("audioTimingInfo",t.trigger.bind(t,"audioTimingInfo")),e.on("videoTimingInfo",t.trigger.bind(t,"videoTimingInfo")),e.on("trackinfo",t.trigger.bind(t,"trackinfo")),e.on("id3Frame",function(i){i.dispatchType=e.metadataStream.dispatchType,i.cueTime=Vt.videoTsToSeconds(i.pts),t.trigger("id3Frame",i)}),e.on("caption",function(i){t.trigger("caption",i)})},wr=function s(e){var t=null,i=!0;e=e||{},s.prototype.init.call(this),e.baseMediaDecodeTime=e.baseMediaDecodeTime||0,this.push=function(r){if(i){var n=qa(r);n&&(!t||t.type!=="aac")?(t=Za(e),br(t,this)):!n&&(!t||t.type!=="ts")&&(t=ja(e),br(t,this)),i=!1}t.headOfPipeline.push(r)},this.flush=function(){t&&(i=!0,t.headOfPipeline.flush())},this.partialFlush=function(){t&&t.headOfPipeline.partialFlush()},this.endTimeline=function(){t&&t.headOfPipeline.endTimeline()},this.reset=function(){t&&t.headOfPipeline.reset()},this.setBaseMediaDecodeTime=function(r){e.keepOriginalTimestamps||(e.baseMediaDecodeTime=r),t&&(t.tracks.audio&&(t.tracks.audio.timelineStartInfo.dts=void 0,t.tracks.audio.timelineStartInfo.pts=void 0,Sr.clearDtsInfo(t.tracks.audio),t.audioRollover&&t.audioRollover.discontinuity()),t.tracks.video&&(t.videoSegmentStream&&(t.videoSegmentStream.gopCache_=[]),t.tracks.video.timelineStartInfo.dts=void 0,t.tracks.video.timelineStartInfo.pts=void 0,Sr.clearDtsInfo(t.tracks.video)),t.timestampRollover&&t.timestampRollover.discontinuity())},this.setRemux=function(r){e.remux=r,t&&t.coalesceStream&&t.coalesceStream.setRemux(r)},this.setAudioAppendStart=function(r){!t||!t.tracks.audio||!t.audioSegmentStream||t.audioSegmentStream.setAudioAppendStart(r)},this.alignGopsWith=function(r){}};wr.prototype=new xr;var Ja=wr,Qa={Transmuxer:Ja},$t,_r;function es(){if(_r)return $t;_r=1;var s=ne.getUint64,e=function(i){var r=new DataView(i.buffer,i.byteOffset,i.byteLength),n={version:i[0],flags:new Uint8Array(i.subarray(1,4)),references:[],referenceId:r.getUint32(4),timescale:r.getUint32(8)},a=12;n.version===0?(n.earliestPresentationTime=r.getUint32(a),n.firstOffset=r.getUint32(a+4),a+=8):(n.earliestPresentationTime=s(i.subarray(a)),n.firstOffset=s(i.subarray(a+8)),a+=16),a+=2;var o=r.getUint16(a);for(a+=2;o>0;a+=12,o--)n.references.push({referenceType:(i[a]&128)>>>7,referencedSize:r.getUint32(a)&2147483647,subsegmentDuration:r.getUint32(a+4),startsWithSap:!!(i[a+8]&128),sapType:(i[a+8]&112)>>>4,sapDeltaTime:r.getUint32(a+8)&268435455});return n};return $t=e,$t}var Fr=ne;Fr.MAX_UINT32;var Ar=Fr.getUint64,I,zt,k=function(e){return new Date(e*1e3-20828448e5)},be=xt,ts=yt,is=function(e){var t=new DataView(e.buffer,e.byteOffset,e.byteLength),i=[],r,n;for(r=0;r+4<e.length;r+=n){if(n=t.getUint32(r),r+=4,n<=0){i.push("<span style='color:red;'>MALFORMED DATA</span>");continue}switch(e[r]&31){case 1:i.push("slice_layer_without_partitioning_rbsp");break;case 5:i.push("slice_layer_without_partitioning_rbsp_idr");break;case 6:i.push("sei_rbsp");break;case 7:i.push("seq_parameter_set_rbsp");break;case 8:i.push("pic_parameter_set_rbsp");break;case 9:i.push("access_unit_delimiter_rbsp");break;default:i.push("UNKNOWN NAL - "+e[r]&31);break}}return i},j={avc1:function(e){var t=new DataView(e.buffer,e.byteOffset,e.byteLength);return{dataReferenceIndex:t.getUint16(6),width:t.getUint16(24),height:t.getUint16(26),horizresolution:t.getUint16(28)+t.getUint16(30)/16,vertresolution:t.getUint16(32)+t.getUint16(34)/16,frameCount:t.getUint16(40),depth:t.getUint16(74),config:I(e.subarray(78,e.byteLength))}},avcC:function(e){var t=new DataView(e.buffer,e.byteOffset,e.byteLength),i={configurationVersion:e[0],avcProfileIndication:e[1],profileCompatibility:e[2],avcLevelIndication:e[3],lengthSizeMinusOne:e[4]&3,sps:[],pps:[]},r=e[5]&31,n,a,o,u;for(o=6,u=0;u<r;u++)a=t.getUint16(o),o+=2,i.sps.push(new Uint8Array(e.subarray(o,o+a))),o+=a;for(n=e[o],o++,u=0;u<n;u++)a=t.getUint16(o),o+=2,i.pps.push(new Uint8Array(e.subarray(o,o+a))),o+=a;return i},btrt:function(e){var t=new DataView(e.buffer,e.byteOffset,e.byteLength);return{bufferSizeDB:t.getUint32(0),maxBitrate:t.getUint32(4),avgBitrate:t.getUint32(8)}},edts:function(e){return{boxes:I(e)}},elst:function(e){var t=new DataView(e.buffer,e.byteOffset,e.byteLength),i={version:t.getUint8(0),flags:new Uint8Array(e.subarray(1,4)),edits:[]},r=t.getUint32(4),n;for(n=8;r;r--)i.version===0?(i.edits.push({segmentDuration:t.getUint32(n),mediaTime:t.getInt32(n+4),mediaRate:t.getUint16(n+8)+t.getUint16(n+10)/(256*256)}),n+=12):(i.edits.push({segmentDuration:Ar(e.subarray(n)),mediaTime:Ar(e.subarray(n+8)),mediaRate:t.getUint16(n+16)+t.getUint16(n+18)/(256*256)}),n+=20);return i},esds:function(e){return{version:e[0],flags:new Uint8Array(e.subarray(1,4)),esId:e[6]<<8|e[7],streamPriority:e[8]&31,decoderConfig:{objectProfileIndication:e[11],streamType:e[12]>>>2&63,bufferSize:e[13]<<16|e[14]<<8|e[15],maxBitrate:e[16]<<24|e[17]<<16|e[18]<<8|e[19],avgBitrate:e[20]<<24|e[21]<<16|e[22]<<8|e[23],decoderConfigDescriptor:{tag:e[24],length:e[25],audioObjectType:e[26]>>>3&31,samplingFrequencyIndex:(e[26]&7)<<1|e[27]>>>7&1,channelConfiguration:e[27]>>>3&15}}}},ftyp:function(e){for(var t=new DataView(e.buffer,e.byteOffset,e.byteLength),i={majorBrand:be(e.subarray(0,4)),minorVersion:t.getUint32(4),compatibleBrands:[]},r=8;r<e.byteLength;)i.compatibleBrands.push(be(e.subarray(r,r+4))),r+=4;return i},dinf:function(e){return{boxes:I(e)}},dref:function(e){return{version:e[0],flags:new Uint8Array(e.subarray(1,4)),dataReferences:I(e.subarray(8))}},hdlr:function(e){var t=new DataView(e.buffer,e.byteOffset,e.byteLength),i={version:t.getUint8(0),flags:new Uint8Array(e.subarray(1,4)),handlerType:be(e.subarray(8,12)),name:""},r=8;for(r=24;r<e.byteLength;r++){if(e[r]===0){r++;break}i.name+=String.fromCharCode(e[r])}return i.name=decodeURIComponent(escape(i.name)),i},mdat:function(e){return{byteLength:e.byteLength,nals:is(e)}},mdhd:function(e){var t=new DataView(e.buffer,e.byteOffset,e.byteLength),i=4,r,n={version:t.getUint8(0),flags:new Uint8Array(e.subarray(1,4)),language:""};return n.version===1?(i+=4,n.creationTime=k(t.getUint32(i)),i+=8,n.modificationTime=k(t.getUint32(i)),i+=4,n.timescale=t.getUint32(i),i+=8,n.duration=t.getUint32(i)):(n.creationTime=k(t.getUint32(i)),i+=4,n.modificationTime=k(t.getUint32(i)),i+=4,n.timescale=t.getUint32(i),i+=4,n.duration=t.getUint32(i)),i+=4,r=t.getUint16(i),n.language+=String.fromCharCode((r>>10)+96),n.language+=String.fromCharCode(((r&992)>>5)+96),n.language+=String.fromCharCode((r&31)+96),n},mdia:function(e){return{boxes:I(e)}},mfhd:function(e){return{version:e[0],flags:new Uint8Array(e.subarray(1,4)),sequenceNumber:e[4]<<24|e[5]<<16|e[6]<<8|e[7]}},minf:function(e){return{boxes:I(e)}},mp4a:function(e){var t=new DataView(e.buffer,e.byteOffset,e.byteLength),i={dataReferenceIndex:t.getUint16(6),channelcount:t.getUint16(16),samplesize:t.getUint16(18),samplerate:t.getUint16(24)+t.getUint16(26)/65536};return e.byteLength>28&&(i.streamDescriptor=I(e.subarray(28))[0]),i},moof:function(e){return{boxes:I(e)}},moov:function(e){return{boxes:I(e)}},mvex:function(e){return{boxes:I(e)}},mvhd:function(e){var t=new DataView(e.buffer,e.byteOffset,e.byteLength),i=4,r={version:t.getUint8(0),flags:new Uint8Array(e.subarray(1,4))};return r.version===1?(i+=4,r.creationTime=k(t.getUint32(i)),i+=8,r.modificationTime=k(t.getUint32(i)),i+=4,r.timescale=t.getUint32(i),i+=8,r.duration=t.getUint32(i)):(r.creationTime=k(t.getUint32(i)),i+=4,r.modificationTime=k(t.getUint32(i)),i+=4,r.timescale=t.getUint32(i),i+=4,r.duration=t.getUint32(i)),i+=4,r.rate=t.getUint16(i)+t.getUint16(i+2)/16,i+=4,r.volume=t.getUint8(i)+t.getUint8(i+1)/8,i+=2,i+=2,i+=2*4,r.matrix=new Uint32Array(e.subarray(i,i+9*4)),i+=9*4,i+=6*4,r.nextTrackId=t.getUint32(i),r},pdin:function(e){var t=new DataView(e.buffer,e.byteOffset,e.byteLength);return{version:t.getUint8(0),flags:new Uint8Array(e.subarray(1,4)),rate:t.getUint32(4),initialDelay:t.getUint32(8)}},sdtp:function(e){var t={version:e[0],flags:new Uint8Array(e.subarray(1,4)),samples:[]},i;for(i=4;i<e.byteLength;i++)t.samples.push({dependsOn:(e[i]&48)>>4,isDependedOn:(e[i]&12)>>2,hasRedundancy:e[i]&3});return t},sidx:es(),smhd:function(e){return{version:e[0],flags:new Uint8Array(e.subarray(1,4)),balance:e[4]+e[5]/256}},stbl:function(e){return{boxes:I(e)}},ctts:function(e){var t=new DataView(e.buffer,e.byteOffset,e.byteLength),i={version:t.getUint8(0),flags:new Uint8Array(e.subarray(1,4)),compositionOffsets:[]},r=t.getUint32(4),n;for(n=8;r;n+=8,r--)i.compositionOffsets.push({sampleCount:t.getUint32(n),sampleOffset:t[i.version===0?"getUint32":"getInt32"](n+4)});return i},stss:function(e){var t=new DataView(e.buffer,e.byteOffset,e.byteLength),i={version:t.getUint8(0),flags:new Uint8Array(e.subarray(1,4)),syncSamples:[]},r=t.getUint32(4),n;for(n=8;r;n+=4,r--)i.syncSamples.push(t.getUint32(n));return i},stco:function(e){var t=new DataView(e.buffer,e.byteOffset,e.byteLength),i={version:e[0],flags:new Uint8Array(e.subarray(1,4)),chunkOffsets:[]},r=t.getUint32(4),n;for(n=8;r;n+=4,r--)i.chunkOffsets.push(t.getUint32(n));return i},stsc:function(e){var t=new DataView(e.buffer,e.byteOffset,e.byteLength),i=t.getUint32(4),r={version:e[0],flags:new Uint8Array(e.subarray(1,4)),sampleToChunks:[]},n;for(n=8;i;n+=12,i--)r.sampleToChunks.push({firstChunk:t.getUint32(n),samplesPerChunk:t.getUint32(n+4),sampleDescriptionIndex:t.getUint32(n+8)});return r},stsd:function(e){return{version:e[0],flags:new Uint8Array(e.subarray(1,4)),sampleDescriptions:I(e.subarray(8))}},stsz:function(e){var t=new DataView(e.buffer,e.byteOffset,e.byteLength),i={version:e[0],flags:new Uint8Array(e.subarray(1,4)),sampleSize:t.getUint32(4),entries:[]},r;for(r=12;r<e.byteLength;r+=4)i.entries.push(t.getUint32(r));return i},stts:function(e){var t=new DataView(e.buffer,e.byteOffset,e.byteLength),i={version:e[0],flags:new Uint8Array(e.subarray(1,4)),timeToSamples:[]},r=t.getUint32(4),n;for(n=8;r;n+=8,r--)i.timeToSamples.push({sampleCount:t.getUint32(n),sampleDelta:t.getUint32(n+4)});return i},styp:function(e){return j.ftyp(e)},tfdt:Tt,tfhd:vt,tkhd:function(e){var t=new DataView(e.buffer,e.byteOffset,e.byteLength),i=4,r={version:t.getUint8(0),flags:new Uint8Array(e.subarray(1,4))};return r.version===1?(i+=4,r.creationTime=k(t.getUint32(i)),i+=8,r.modificationTime=k(t.getUint32(i)),i+=4,r.trackId=t.getUint32(i),i+=4,i+=8,r.duration=t.getUint32(i)):(r.creationTime=k(t.getUint32(i)),i+=4,r.modificationTime=k(t.getUint32(i)),i+=4,r.trackId=t.getUint32(i),i+=4,i+=4,r.duration=t.getUint32(i)),i+=4,i+=2*4,r.layer=t.getUint16(i),i+=2,r.alternateGroup=t.getUint16(i),i+=2,r.volume=t.getUint8(i)+t.getUint8(i+1)/8,i+=2,i+=2,r.matrix=new Uint32Array(e.subarray(i,i+9*4)),i+=9*4,r.width=t.getUint16(i)+t.getUint16(i+2)/65536,i+=4,r.height=t.getUint16(i)+t.getUint16(i+2)/65536,r},traf:function(e){return{boxes:I(e)}},trak:function(e){return{boxes:I(e)}},trex:function(e){var t=new DataView(e.buffer,e.byteOffset,e.byteLength);return{version:e[0],flags:new Uint8Array(e.subarray(1,4)),trackId:t.getUint32(4),defaultSampleDescriptionIndex:t.getUint32(8),defaultSampleDuration:t.getUint32(12),defaultSampleSize:t.getUint32(16),sampleDependsOn:e[20]&3,sampleIsDependedOn:(e[21]&192)>>6,sampleHasRedundancy:(e[21]&48)>>4,samplePaddingValue:(e[21]&14)>>1,sampleIsDifferenceSample:!!(e[21]&1),sampleDegradationPriority:t.getUint16(22)}},trun:St,"url ":function(e){return{version:e[0],flags:new Uint8Array(e.subarray(1,4))}},vmhd:function(e){var t=new DataView(e.buffer,e.byteOffset,e.byteLength);return{version:e[0],flags:new Uint8Array(e.subarray(1,4)),graphicsmode:t.getUint16(4),opcolor:new Uint16Array([t.getUint16(6),t.getUint16(8),t.getUint16(10)])}}};I=function(e){for(var t=0,i=[],r,n,a,o,u,f=new ArrayBuffer(e.length),l=new Uint8Array(f),d=0;d<e.length;++d)l[d]=e[d];for(r=new DataView(f);t<e.byteLength;)n=r.getUint32(t),a=be(e.subarray(t+4,t+8)),o=n>1?t+n:e.byteLength,u=(j[a]||function(h){return{data:h}})(e.subarray(t+8,o)),u.size=n,u.type=a,i.push(u),t=o;return i},zt=function(e,t){var i;return t=t||0,i=new Array(t*2+1).join(" "),e.map(function(r,n){return i+r.type+`
`+Object.keys(r).filter(function(a){return a!=="type"&&a!=="boxes"}).map(function(a){var o=i+"  "+a+": ",u=r[a];if(u instanceof Uint8Array||u instanceof Uint32Array){var f=Array.prototype.slice.call(new Uint8Array(u.buffer,u.byteOffset,u.byteLength)).map(function(l){return" "+("00"+l.toString(16)).slice(-2)}).join("").match(/.{1,24}/g);return f?f.length===1?o+"<"+f.join("").slice(1)+">":o+`<
`+f.map(function(l){return i+"  "+l}).join(`
`)+`
`+i+"  >":o+"<>"}return o+JSON.stringify(u,null,2).split(`
`).map(function(l,d){return d===0?l:i+"  "+l}).join(`
`)}).join(`
`)+(r.boxes?`
`+zt(r.boxes,t+1):"")}).join(`
`)};var rs={inspect:I,textify:zt,parseType:be,findBox:ts,parseTraf:j.traf,parseTfdt:j.tfdt,parseHdlr:j.hdlr,parseTfhd:j.tfhd,parseTrun:j.trun,parseSidx:j.sidx},ns={8:"audio",9:"video",18:"metadata"},as=function(e){return"0x"+("00"+e.toString(16)).slice(-2).toUpperCase()},Gt=function(e){for(var t=[],i;e.byteLength>0;)i=0,t.push(as(e[i++])),e=e.subarray(i);return t.join(" ")},ss=function(e,t){var i=["AVC Sequence Header","AVC NALU","AVC End-of-Sequence"],r=e[1]&parseInt("01111111",2)<<16|e[2]<<8|e[3];return t=t||{},t.avcPacketType=i[e[0]],t.CompositionTime=e[1]&parseInt("10000000",2)?-r:r,e[0]===1?t.nalUnitTypeRaw=Gt(e.subarray(4,100)):t.data=Gt(e.subarray(4)),t},os=function(e,t){var i=["Unknown","Keyframe (for AVC, a seekable frame)","Inter frame (for AVC, a nonseekable frame)","Disposable inter frame (H.263 only)","Generated keyframe (reserved for server use only)","Video info/command frame"],r=e[0]&parseInt("00001111",2);return t=t||{},t.frameType=i[(e[0]&parseInt("11110000",2))>>>4],t.codecID=r,r===7?ss(e.subarray(1),t):t},us=function(e,t){var i=["AAC Sequence Header","AAC Raw"];return t=t||{},t.aacPacketType=i[e[0]],t.data=Gt(e.subarray(1)),t},ls=function(e,t){var i=["Linear PCM, platform endian","ADPCM","MP3","Linear PCM, little endian","Nellymoser 16-kHz mono","Nellymoser 8-kHz mono","Nellymoser","G.711 A-law logarithmic PCM","G.711 mu-law logarithmic PCM","reserved","AAC","Speex","MP3 8-Khz","Device-specific sound"],r=["5.5-kHz","11-kHz","22-kHz","44-kHz"],n=(e[0]&parseInt("11110000",2))>>>4;return t=t||{},t.soundFormat=i[n],t.soundRate=r[(e[0]&parseInt("00001100",2))>>>2],t.soundSize=(e[0]&parseInt("00000010",2))>>>1?"16-bit":"8-bit",t.soundType=e[0]&parseInt("00000001",2)?"Stereo":"Mono",n===10?us(e.subarray(1),t):t},fs=function(e){return{tagType:ns[e[0]],dataSize:e[1]<<16|e[2]<<8|e[3],timestamp:e[7]<<24|e[4]<<16|e[5]<<8|e[6],streamID:e[8]<<16|e[9]<<8|e[10]}},Dr=function(e){var t=fs(e);switch(e[0]){case 8:ls(e.subarray(11),t);break;case 9:os(e.subarray(11),t);break}return t},ds=function(e){var t=9,i,r=[],n;for(t+=4;t<e.byteLength;)i=e[t+1]<<16,i|=e[t+2]<<8,i|=e[t+3],i+=11,n=e.subarray(t,t+i),r.push(Dr(n)),t+=i+4;return r},hs=function(e){return JSON.stringify(e,null,2)},ps={inspectTag:Dr,inspect:ds,textify:hs},Wt=ze,Ur=function(e){var t=e[1]&31;return t<<=8,t|=e[2],t},at=function(e){return!!(e[1]&64)},st=function(e){var t=0;return(e[3]&48)>>>4>1&&(t+=e[4]+1),t},ms=function(e,t){var i=Ur(e);return i===0?"pat":i===t?"pmt":t?"pes":null},cs=function(e){var t=at(e),i=4+st(e);return t&&(i+=e[i]+1),(e[i+10]&31)<<8|e[i+11]},gs=function(e){var t={},i=at(e),r=4+st(e);if(i&&(r+=e[r]+1),!!(e[r+5]&1)){var n,a,o;n=(e[r+1]&15)<<8|e[r+2],a=3+n-4,o=(e[r+10]&15)<<8|e[r+11];for(var u=12+o;u<a;){var f=r+u;t[(e[f+1]&31)<<8|e[f+2]]=e[f],u+=((e[f+3]&15)<<8|e[f+4])+5}return t}},xs=function(e,t){var i=Ur(e),r=t[i];switch(r){case Wt.H264_STREAM_TYPE:return"video";case Wt.ADTS_STREAM_TYPE:return"audio";case Wt.METADATA_STREAM_TYPE:return"timed-metadata";default:return null}},ys=function(e){var t=at(e);if(!t)return null;var i=4+st(e);if(i>=e.byteLength)return null;var r=null,n;return n=e[i+7],n&192&&(r={},r.pts=(e[i+9]&14)<<27|(e[i+10]&255)<<20|(e[i+11]&254)<<12|(e[i+12]&255)<<5|(e[i+13]&254)>>>3,r.pts*=4,r.pts+=(e[i+13]&6)>>>1,r.dts=r.pts,n&64&&(r.dts=(e[i+14]&14)<<27|(e[i+15]&255)<<20|(e[i+16]&254)<<12|(e[i+17]&255)<<5|(e[i+18]&254)>>>3,r.dts*=4,r.dts+=(e[i+18]&6)>>>1)),r},Ht=function(e){switch(e){case 5:return"slice_layer_without_partitioning_rbsp_idr";case 6:return"sei_rbsp";case 7:return"seq_parameter_set_rbsp";case 8:return"pic_parameter_set_rbsp";case 9:return"access_unit_delimiter_rbsp";default:return null}},vs=function(e){for(var t=4+st(e),i=e.subarray(t),r=0,n=0,a=!1,o;n<i.byteLength-3;n++)if(i[n+2]===1){r=n+5;break}for(;r<i.byteLength;)switch(i[r]){case 0:if(i[r-1]!==0){r+=2;break}else if(i[r-2]!==0){r++;break}n+3!==r-2&&(o=Ht(i[n+3]&31),o==="slice_layer_without_partitioning_rbsp_idr"&&(a=!0));do r++;while(i[r]!==1&&r<i.length);n=r-2,r+=3;break;case 1:if(i[r-1]!==0||i[r-2]!==0){r+=3;break}o=Ht(i[n+3]&31),o==="slice_layer_without_partitioning_rbsp_idr"&&(a=!0),n=r-2,r+=3;break;default:r+=3;break}return i=i.subarray(n),r-=n,n=0,i&&i.byteLength>3&&(o=Ht(i[n+3]&31),o==="slice_layer_without_partitioning_rbsp_idr"&&(a=!0)),a},Ss={parseType:ms,parsePat:cs,parsePmt:gs,parsePayloadUnitStartIndicator:at,parsePesType:xs,parsePesTime:ys,videoPacketContainsKeyFrame:vs},Pr=ze,ue=ji.handleRollover,b={};b.ts=Ss,b.aac=qe;var ee=Y.ONE_SECOND_IN_TS,E=188,$=71,Ts=function(e,t){for(var i=0,r=E,n,a;r<e.byteLength;){if(e[i]===$&&e[r]===$){switch(n=e.subarray(i,r),a=b.ts.parseType(n,t.pid),a){case"pat":t.pid=b.ts.parsePat(n);break;case"pmt":var o=b.ts.parsePmt(n);t.table=t.table||{},Object.keys(o).forEach(function(u){t.table[u]=o[u]});break}i+=E,r+=E;continue}i++,r++}},Cr=function(e,t,i){for(var r=0,n=E,a,o,u,f,l,d=!1;n<=e.byteLength;){if(e[r]===$&&(e[n]===$||n===e.byteLength)){switch(a=e.subarray(r,n),o=b.ts.parseType(a,t.pid),o){case"pes":u=b.ts.parsePesType(a,t.table),f=b.ts.parsePayloadUnitStartIndicator(a),u==="audio"&&f&&(l=b.ts.parsePesTime(a),l&&(l.type="audio",i.audio.push(l),d=!0));break}if(d)break;r+=E,n+=E;continue}r++,n++}for(n=e.byteLength,r=n-E,d=!1;r>=0;){if(e[r]===$&&(e[n]===$||n===e.byteLength)){switch(a=e.subarray(r,n),o=b.ts.parseType(a,t.pid),o){case"pes":u=b.ts.parsePesType(a,t.table),f=b.ts.parsePayloadUnitStartIndicator(a),u==="audio"&&f&&(l=b.ts.parsePesTime(a),l&&(l.type="audio",i.audio.push(l),d=!0));break}if(d)break;r-=E,n-=E;continue}r--,n--}},bs=function(e,t,i){for(var r=0,n=E,a,o,u,f,l,d,h,m,p=!1,c={data:[],size:0};n<e.byteLength;){if(e[r]===$&&e[n]===$){switch(a=e.subarray(r,n),o=b.ts.parseType(a,t.pid),o){case"pes":if(u=b.ts.parsePesType(a,t.table),f=b.ts.parsePayloadUnitStartIndicator(a),u==="video"&&(f&&!p&&(l=b.ts.parsePesTime(a),l&&(l.type="video",i.video.push(l),p=!0)),!i.firstKeyFrame)){if(f&&c.size!==0){for(d=new Uint8Array(c.size),h=0;c.data.length;)m=c.data.shift(),d.set(m,h),h+=m.byteLength;if(b.ts.videoPacketContainsKeyFrame(d)){var g=b.ts.parsePesTime(d);g?(i.firstKeyFrame=g,i.firstKeyFrame.type="video"):console.warn("Failed to extract PTS/DTS from PES at first keyframe. This could be an unusual TS segment, or else mux.js did not parse your TS segment correctly. If you know your TS segments do contain PTS/DTS on keyframes please file a bug report! You can try ffprobe to double check for yourself.")}c.size=0}c.data.push(a),c.size+=a.byteLength}break}if(p&&i.firstKeyFrame)break;r+=E,n+=E;continue}r++,n++}for(n=e.byteLength,r=n-E,p=!1;r>=0;){if(e[r]===$&&e[n]===$){switch(a=e.subarray(r,n),o=b.ts.parseType(a,t.pid),o){case"pes":u=b.ts.parsePesType(a,t.table),f=b.ts.parsePayloadUnitStartIndicator(a),u==="video"&&f&&(l=b.ts.parsePesTime(a),l&&(l.type="video",i.video.push(l),p=!0));break}if(p)break;r-=E,n-=E;continue}r--,n--}},ws=function(e,t){if(e.audio&&e.audio.length){var i=t;(typeof i>"u"||isNaN(i))&&(i=e.audio[0].dts),e.audio.forEach(function(a){a.dts=ue(a.dts,i),a.pts=ue(a.pts,i),a.dtsTime=a.dts/ee,a.ptsTime=a.pts/ee})}if(e.video&&e.video.length){var r=t;if((typeof r>"u"||isNaN(r))&&(r=e.video[0].dts),e.video.forEach(function(a){a.dts=ue(a.dts,r),a.pts=ue(a.pts,r),a.dtsTime=a.dts/ee,a.ptsTime=a.pts/ee}),e.firstKeyFrame){var n=e.firstKeyFrame;n.dts=ue(n.dts,r),n.pts=ue(n.pts,r),n.dtsTime=n.dts/ee,n.ptsTime=n.pts/ee}}},_s=function(e){for(var t=!1,i=0,r=null,n=null,a=0,o=0,u;e.length-o>=3;){var f=b.aac.parseType(e,o);switch(f){case"timed-metadata":if(e.length-o<10){t=!0;break}if(a=b.aac.parseId3TagSize(e,o),a>e.length){t=!0;break}n===null&&(u=e.subarray(o,o+a),n=b.aac.parseAacTimestamp(u)),o+=a;break;case"audio":if(e.length-o<7){t=!0;break}if(a=b.aac.parseAdtsSize(e,o),a>e.length){t=!0;break}r===null&&(u=e.subarray(o,o+a),r=b.aac.parseSampleRate(u)),i++,o+=a;break;default:o++;break}if(t)return null}if(r===null||n===null)return null;var l=ee/r,d={audio:[{type:"audio",dts:n,pts:n},{type:"audio",dts:n+i*1024*l,pts:n+i*1024*l}]};return d},Fs=function(e){var t={pid:null,table:null},i={};Ts(e,t);for(var r in t.table)if(t.table.hasOwnProperty(r)){var n=t.table[r];switch(n){case Pr.H264_STREAM_TYPE:i.video=[],bs(e,t,i),i.video.length===0&&delete i.video;break;case Pr.ADTS_STREAM_TYPE:i.audio=[],Cr(e,t,i),i.audio.length===0&&delete i.audio;break}}return i},As=function(e,t){var i=b.aac.isLikelyAacData(e),r;return i?r=_s(e):r=Fs(e),!r||!r.audio&&!r.video?null:(ws(r,t),r)},Ds={inspect:As,parseAudioPes_:Cr},ot={codecs:Qt,mp4:Aa,flv:Na,mp2t:ka,partial:Qa};ot.mp4.tools=rs,ot.flv.tools=ps,ot.mp2t.tools=Ds;var Us=ot;const Ps=Or(Us);async function Cs(s,e={}){let t=!1,i=[],r=[],n=[0],a=0,o=[0],u=[0],f=[],l=!0,d=0,h="",m=null,p=e;if(t){e.onError&&e.onError(new Error("\u6B63\u5728\u4E0B\u8F7D\u4E2D\uFF0C\u8BF7\u7A0D\u540E..."));return}if(!s){e.onError&&e.onError(new Error("\u8BF7\u63D0\u4F9BM3U8\u94FE\u63A5"));return}if(s.toLowerCase().indexOf("m3u8")===-1){e.onError&&e.onError(new Error("\u94FE\u63A5\u683C\u5F0F\u4E0D\u6B63\u786E\uFF0C\u8BF7\u786E\u4FDD\u662FM3U8\u683C\u5F0F"));return}l=!0,t=!0,m=new Date;try{h=new URL(s).searchParams.get("title")||""}catch{h=""}!h&&e.filename&&(h=e.filename),e.onProgress&&e.onProgress(0,0,0,"\u5F00\u59CB\u4E0B\u8F7DM3U8\u6587\u4EF6...");try{await c(s),t=!1}catch(D){console.error("\u4E0B\u8F7D\u5931\u8D25:",D),t=!1,e.onError&&e.onError(D)}async function c(D){const v=await Ir(D);if(i.length=0,r.length=0,n[0]=0,o[0]=0,u[0]=0,f.length=0,d=0,v.split(`
`).forEach(P=>{/^[^#]/.test(P)&&P.trim()&&(i.push(Is(P,D)),r.push({title:P,status:""}))}),a=i.length,a===0)throw new Error("\u6CA1\u6709\u627E\u5230\u6709\u6548\u7684\u89C6\u9891\u7247\u6BB5");l&&v.split(`
`).forEach(P=>{P.toUpperCase().indexOf("#EXTINF:")>-1&&(d+=parseFloat(P.split("#EXTINF:")[1]))}),p.onProgress&&p.onProgress(0,a,0,`\u627E\u5230${a}\u4E2A\u89C6\u9891\u7247\u6BB5\uFF0C\u5F00\u59CB\u4E0B\u8F7D...`),w()}const g=()=>{let D=0;for(let v=0;v<r.length;v++)(r[v].status==="finish"||r[v].status==="error")&&D++;return console.log(`\u5DF2\u5B8C\u6210: ${D}/${a}, \u6210\u529F: ${o[0]}, \u9519\u8BEF: ${u[0]}`),D===a?(p.onProgress&&p.onProgress(a,a,u[0],"\u4E0B\u8F7D\u5B8C\u6210\uFF0C\u5F00\u59CB\u4FDD\u5B58\u6587\u4EF6..."),setTimeout(()=>{we()},500),!0):!1};function w(){const D=()=>{const v=n[0];if(v>=a){g();return}n[0]++,r[v]&&r[v].status===""?(r[v].status="downloading",Ir(i[v],"file").then(P=>F(P,v,D)).catch(()=>{u[0]++,r[v].status="error",p.onProgress&&p.onProgress(o[0],a,u[0],`\u4E0B\u8F7D\u8FDB\u5EA6: ${o[0]}/${a}, \u9519\u8BEF: ${u[0]}`),g()||D()})):D()};for(let v=0;v<Math.min(10,a);v++)D()}async function F(D,v,P){try{const L=await H(D,v);f[v]=L,r[v].status="finish",o[0]++,p.onProgress&&p.onProgress(o[0],a,u[0],`\u4E0B\u8F7D\u8FDB\u5EA6: ${o[0]}/${a}, \u9519\u8BEF: ${u[0]}`),g()||P&&P()}catch(L){console.error("\u5904\u7406TS\u7247\u6BB5\u5931\u8D25:",L),u[0]++,r[v].status="error",g()||P&&P()}}function H(D,v){return new Promise(P=>{const L=new Ps.mp4.Transmuxer({keepOriginalTimestamps:!0,duration:parseInt(d)});L.on("data",O=>{if(v===0){const A=new Uint8Array(O.initSegment.byteLength+O.data.byteLength);A.set(O.initSegment,0),A.set(O.data,O.initSegment.byteLength),P(A.buffer)}else P(O.data)}),L.push(new Uint8Array(D)),L.flush()})}function we(){const D=h||Es(m,"YYYY_MM_DD hh_mm_ss"),v=new Blob(f,{type:"video/mp4"}),P=D+".mp4",L=URL.createObjectURL(v),O=document.createElement("a");O.href=L,O.download=P,document.body.appendChild(O),O.click(),document.body.removeChild(O),URL.revokeObjectURL(L),p.onSuccess&&p.onSuccess({blob:v,filename:P,mimeType:"video/mp4",size:v.size})}}function Is(s,e){if(e=e||window.location.href,s.indexOf("http")===0)return window.location.href.indexOf("https")===0?s.replace("http://","https://"):s;if(s[0]==="/"){const t=e.split("/");return t[0]+"//"+t[2]+s}else{const t=e.split("/");return t.pop(),t.join("/")+"/"+s}}function Ir(s,e="text"){return new Promise((t,i)=>{const r=new XMLHttpRequest;e==="file"&&(r.responseType="arraybuffer"),r.onreadystatechange=function(){r.readyState===4&&(r.status>=200&&r.status<300?t(r.response):i(new Error(`HTTP ${r.status}`)))},r.onerror=function(){i(new Error("\u7F51\u7EDC\u8BF7\u6C42\u5931\u8D25"))},r.open("GET",s,!0),r.send(null)})}function Es(s,e){const t={Y:s.getFullYear(),M:s.getMonth()+1,D:s.getDate(),h:s.getHours(),m:s.getMinutes(),s:s.getSeconds()};return e.replace(/Y+|M+|D+|h+|m+|s+/g,i=>(new Array(i.length).join("0")+t[i[0]]).substr(-i.length))}ie.downloadM3U8=Cs,Object.defineProperty(ie,Symbol.toStringTag,{value:"Module"})});
